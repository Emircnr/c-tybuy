<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>City Sell - Harita Oyunu</title>
  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- amCharts 5 CSS (Opsiyonel: ek stil ayarları) -->
  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #chartdiv {
      width: 100%;
      height: calc(100vh - 56px); /* Navbar yüksekliği kadar eksiltildi */
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">City Sell</a>
      <div class="ms-auto">
        <!-- Profil butonu; kullanıcı giriş yaptıktan sonra görünür -->
        <button id="profileBtn" type="button" class="btn btn-outline-light me-2 d-none" data-bs-toggle="modal" data-bs-target="#profileModal">
          Profil
        </button>
        <!-- Çıkış butonu -->
        <button id="logoutBtn" type="button" class="btn btn-outline-light d-none">Çıkış</button>
      </div>
    </div>
  </nav>

  <!-- Harita container -->
  <div id="chartdiv"></div>

  <!-- Giriş / Kayıt Modalı (hem login hem kayıt için) -->
  <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="authModalLabel" class="modal-title">Giriş Yap / Kayıt Ol</h5>
        </div>
        <div class="modal-body">
          <form id="authForm">
            <div class="mb-3">
              <label for="usernameInput" class="form-label">Kullanıcı Adı</label>
              <input type="text" class="form-control" id="usernameInput" placeholder="Kullanıcı adınızı girin">
            </div>
            <div class="mb-3">
              <label for="emailInput" class="form-label">E-posta</label>
              <input type="email" class="form-control" id="emailInput" placeholder="E-posta adresinizi girin" required>
            </div>
            <div class="mb-3">
              <label for="passwordInput" class="form-label">Şifre</label>
              <input type="password" class="form-control" id="passwordInput" placeholder="En az 6 karakter" required>
            </div>
            <div class="d-flex justify-content-between">
              <button type="submit" id="registerBtn" class="btn btn-primary">Kayıt Ol</button>
              <button type="button" id="loginBtn" class="btn btn-success">Giriş Yap</button>
            </div>
          </form>
          <div id="authError" class="mt-3 text-danger"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profil Modalı -->
  <div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="profileModalLabel" class="modal-title">Profil Bilgilerim</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <p><strong>Kullanıcı Adı:</strong> <span id="profileUsername"></span></p>
          <p><strong>E-posta:</strong> <span id="profileEmail"></span></p>
          <p><strong>Bakiye (USDT):</strong> <span id="profileBalance"></span></p>
          <p><strong>Sahip Olunan Şehirler:</strong> <span id="profileCities"></span></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Şehir Detay Modalı -->
  <div class="modal fade" id="cityModal" tabindex="-1" aria-labelledby="cityModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 id="cityModalLabel" class="modal-title">Şehir Detayları</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
        </div>
        <div class="modal-body">
          <p><strong>Şehir:</strong> <span id="cityName"></span></p>
          <p><strong>Fiyat (USDT):</strong> <span id="cityPrice"></span></p>
          <p><strong>Mevcut Sahip:</strong> <span id="cityOwner"></span></p>
        </div>
        <div class="modal-footer">
          <button type="button" id="buyCityBtn" class="btn btn-primary">Satın Al</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase App (the core Firebase SDK) -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <!-- Firebase Authentication -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
  <!-- Firebase Firestore -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

  <!-- amCharts 5 Resources -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
  
  <!-- Bootstrap 5 JS (Bundle includes Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Uygulama JS Kodu -->
  <script>
    /***** Firebase Konfigürasyonu ve Başlatılması *****/
    const firebaseConfig = {
      apiKey: "AIzaSyB2LQX2rSPYmV9fCn9S02R1zz9welQ9Skc",
      authDomain: "citysell-45e32.firebaseapp.com",
      projectId: "citysell-45e32",
      storageBucket: "citysell-45e32.firebasestorage.app",
      messagingSenderId: "325438858648",
      appId: "1:325438858648:web:0c13beb02cd1a2b08fb7ed",
      measurementId: "G-2HR99X6LXY"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    /***** DOM Elemanları Seçimleri *****/
    const authModal = new bootstrap.Modal(document.getElementById('authModal'));
    const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
    const cityModal = new bootstrap.Modal(document.getElementById('cityModal'));

    const authForm = document.getElementById('authForm');
    const usernameInput = document.getElementById('usernameInput');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const authError = document.getElementById('authError');
    const registerBtn = document.getElementById('registerBtn');
    const loginBtn = document.getElementById('loginBtn');

    const profileBtn = document.getElementById('profileBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileUsername = document.getElementById('profileUsername');
    const profileEmail = document.getElementById('profileEmail');
    const profileBalance = document.getElementById('profileBalance');
    const profileCities = document.getElementById('profileCities');

    const cityNameSpan = document.getElementById('cityName');
    const cityPriceSpan = document.getElementById('cityPrice');
    const cityOwnerSpan = document.getElementById('cityOwner');
    const buyCityBtn = document.getElementById('buyCityBtn');

    // Global değişkenler
    let currentUser = null;
    let selectedCity = null; // Şehir detay modalında seçilen şehir

    /***** Kullanıcı Kayıt İşlemi *****/
    registerBtn.addEventListener('click', (e) => {
      e.preventDefault();
      authError.textContent = "";
      const username = usernameInput.value.trim();
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      if(password.length < 6) {
        authError.textContent = "Şifre en az 6 karakter olmalı.";
        return;
      }
      // Yeni kullanıcı oluştur
      auth.createUserWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          // Kullanıcı verilerini Firestore'a kaydet (başlangıç bakiyesi: 100 USDT, sahip olunan şehirler: boş dizi)
          return db.collection("users").doc(currentUser.uid).set({
            username: username,
            email: email,
            balance: 100,
            cities: []
          });
        })
        .then(() => {
          authModal.hide();
        })
        .catch((error) => {
          authError.textContent = error.message;
        });
    });

    /***** Kullanıcı Giriş İşlemi *****/
    loginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      authError.textContent = "";
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();

      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = userCredential.user;
          authModal.hide();
        })
        .catch((error) => {
          authError.textContent = error.message;
        });
    });

    /***** Oturum Değişikliği Dinleyicisi *****/
    auth.onAuthStateChanged((user) => {
      if(user) {
        currentUser = user;
        // Navbar'da profil ve çıkış butonlarını göster
        profileBtn.classList.remove('d-none');
        logoutBtn.classList.remove('d-none');
        // Güncel kullanıcı verilerini al ve göster
        loadUserProfile();
      } else {
        currentUser = null;
        profileBtn.classList.add('d-none');
        logoutBtn.classList.add('d-none');
        // Oturum açmamışsa otomatik auth modalı aç
        authModal.show();
      }
    });

    /***** Profil Bilgilerini Yükleme *****/
    function loadUserProfile() {
      db.collection("users").doc(currentUser.uid).get()
        .then((doc) => {
          if(doc.exists) {
            const data = doc.data();
            profileUsername.textContent = data.username;
            profileEmail.textContent = data.email;
            profileBalance.textContent = data.balance;
            profileCities.textContent = data.cities.join(", ") || "Yok";
          }
        });
    }

    /***** Çıkış İşlemi *****/
    logoutBtn.addEventListener('click', () => {
      auth.signOut();
    });

    /***** Firestore’da Şehir Verisi Seed İşlemi *****/
    function seedCities() {
      db.collection("cities").get()
        .then((snapshot) => {
          if(snapshot.empty) {
            // Örnek şehirler: İstanbul, Ankara, İzmir
            const cities = [
              { name: "İstanbul", latitude: 41.0082, longitude: 28.9784, price: 50, ownerId: null },
              { name: "Ankara", latitude: 39.9208, longitude: 32.8541, price: 40, ownerId: null },
              { name: "İzmir", latitude: 38.4237, longitude: 27.1428, price: 45, ownerId: null }
            ];
            const batch = db.batch();
            cities.forEach(city => {
              const docRef = db.collection("cities").doc(); // otomatik ID
              batch.set(docRef, city);
            });
            return batch.commit();
          }
        })
        .catch(console.error);
    }
    // Seed işlemini sayfa yüklenince çağır
    seedCities();

    /***** amCharts 5 Harita ve Şehir Marker’larının Eklenmesi *****/
    // amCharts 5 kodları: dünya haritası oluşturuluyor
    am5.ready(function() {
      // Root oluşturulması
      let root = am5.Root.new("chartdiv");
      root.setThemes([ am5themes_Animated.new(root) ]);
      
      // MapChart oluşturulması
      let chart = root.container.children.push(am5map.MapChart.new(root, {
        panX: "rotateX",
        projection: am5map.geoMercator()
      }));

      // Dünya poligon serisi
      let worldSeries = chart.series.push(am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow,
        exclude: ["AQ"]
      }));
      worldSeries.mapPolygons.template.setAll({
        tooltipText: "{name}",
        interactive: true,
        fill: am5.color(0xaaaaaa)
      });
      worldSeries.mapPolygons.template.states.create("hover", { fill: am5.color(0x67b7dc) });

      // Haritaya şehir marker’larını eklemek için ImageSeries oluşturuluyor
      let imageSeries = chart.series.push(am5map.MapImageSeries.new(root, {}));
      imageSeries.mapImages.template.setAll({
        tooltipText: "{city}",
        interactive: true,
        centerX: am5.p50,
        centerY: am5.p50,
        pixelHeight: 20,
        pixelWidth: 20,
        templateField: "settings"
      });

      // Marker şablonu için bir daire
      imageSeries.mapImages.template.children.push(
        am5.Circle.new(root, {
          radius: 8,
          fill: am5.color(0xff0000),
          tooltipText: "{city}"
        })
      );

      // Firestore’dan şehir verilerini çekip marker olarak ekleyen fonksiyon
      function loadCitiesOnMap() {
        db.collection("cities").onSnapshot((snapshot) => {
          let cityData = [];
          snapshot.forEach((doc) => {
            const city = doc.data();
            cityData.push({
              city: city.name,
              price: city.price,
              ownerId: city.ownerId,
              id: doc.id,
              latitude: city.latitude,
              longitude: city.longitude,
              // Marker görsel ayarı (hover efekti için)
              settings: { 
                fill: city.ownerId ? am5.color(0x00aa00) : am5.color(0xff0000)
              }
            });
          });
          imageSeries.data.setAll(cityData);
        });
      }
      loadCitiesOnMap();

      // Marker tıklama olayı: Şehir detay modalını aç
      imageSeries.mapImages.template.events.on("click", (ev) => {
        selectedCity = ev.target.dataItem.dataContext;
        // Modal içeriklerini doldur
        cityNameSpan.textContent = selectedCity.city;
        cityPriceSpan.textContent = selectedCity.price;
        cityOwnerSpan.textContent = selectedCity.ownerId ? "Satın Alındı" : "Mevcut Yok";
        cityModal.show();
      });

      // Harita yaklaştırma ve gezinme ayarları (opsiyonel)
      chart.appear(1000, 100);
    }); // end am5.ready

    /***** Şehir Satın Alma İşlemi *****/
    buyCityBtn.addEventListener('click', () => {
      if(!currentUser) {
        alert("Lütfen önce giriş yapın.");
        return;
      }
      if(selectedCity.ownerId) {
        alert("Bu şehir zaten satın alınmış!");
        return;
      }
      // Kullanıcı bakiyesi kontrolü
      db.collection("users").doc(currentUser.uid).get()
      .then((doc) => {
        if(doc.exists) {
          const userData = doc.data();
          if(userData.balance < selectedCity.price) {
            alert("Yeterli bakiyeniz yok!");
            return;
          }
          // İşlem: şehrin sahip bilgisini güncelle, kullanıcının bakiyesini düşür ve şehir adını kullanıcıya ekle.
          const newBalance = userData.balance - selectedCity.price;
          let newCities = userData.cities || [];
          newCities.push(selectedCity.city);
          let cityRef = db.collection("cities").doc(selectedCity.id);
          let userRef = db.collection("users").doc(currentUser.uid);
          // Firestore batch işlemi
          let batch = db.batch();
          batch.update(cityRef, { ownerId: currentUser.uid });
          batch.update(userRef, { balance: newBalance, cities: newCities });
          return batch.commit();
        }
      })
      .then(() => {
        alert("Şehir başarıyla satın alındı!");
        cityModal.hide();
      })
      .catch((error) => {
        console.error("Satın alma hatası:", error);
      });
    });
  </script>
</body>
</html>
