<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MEXC Spot â†” Futures Fark Ä°zleyici (USDT)</title>
<style>
  :root{
    --bg:#0b1220; --fg:#e6edf3; --muted:#9fb0c3; --card:#111a2d; --accent:#20c997;
    --warn:#f0ad4e; --bad:#ff5a5a; --good:#2ecc71; --grid:#1a2438;
    --rowFont:16px; --dense:10px; --gap:8px; --header:18px; --chip:14px; --scale:1;
  }
  body.light{ --bg:#ffffff; --fg:#111; --muted:#444; --card:#f4f6f8; --accent:#0d6efd;
              --grid:#e9ecef; --good:#198754; --warn:#6c757d; --bad:#dc3545; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
  header{position:sticky;top:0;background:linear-gradient(180deg,var(--bg),rgba(0,0,0,0));
         z-index:10;padding:14px 16px 8px;border-bottom:1px solid var(--grid)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .title{font-weight:700;font-size:20px;letter-spacing:.2px}
  .clock{margin-left:auto;font-variant-tabular-nums:tabular-nums;color:var(--muted)}
  .chip{background:var(--card);border:1px solid var(--grid);border-radius:999px;padding:6px 10px;
        font-size:var(--chip);display:inline-flex;gap:8px;align-items:center}
  .chip b{font-weight:700}
  .controls{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px;margin-top:10px}
  .controls > div{background:var(--card);border:1px solid var(--grid);border-radius:14px;padding:10px}
  .controls label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .controls input[type="text"], .controls input[type="number"], .controls select{
      width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--grid);
      background:transparent;color:var(--fg);font-size:14px
  }
  .btn{cursor:pointer;border:1px solid var(--grid);background:var(--card);color:var(--fg);
       padding:8px 12px;border-radius:10px}
  .btn:hover{border-color:var(--accent)}
  .wrap{max-width:1350px;margin:0 auto;padding:0 12px}
  #topCard{margin:12px 0;padding:12px 14px;border-radius:16px;background:var(--card);
           border:1px solid var(--grid);display:flex;align-items:center;gap:12px;min-height:52px}
  #topCard .sym{font-weight:800;font-size:22px;letter-spacing:.3px}
  #topCard .act{background:var(--good);color:#fff;border-radius:999px;padding:6px 10px;font-weight:800}
  #topCard .price{font-weight:700}
  #topCard .pct{font-weight:800}
  #topCard.hidden{display:none}
  table{width:100%;border-collapse:separate;border-spacing:0 8px;transform:scale(var(--scale));
        transform-origin:top left}
  thead th{font-size:calc(var(--header));text-align:left;color:var(--muted);padding:6px 10px}
  tbody td{padding:var(--dense) 10px;background:var(--card);border-top:1px solid var(--grid);
           border-bottom:1px solid var(--grid);font-size:calc(var(--rowFont))}
  tbody tr{transition:background .15s}
  tbody tr:hover td{background:rgba(255,255,255,0.03)}
  td.c0{border-left:1px solid var(--grid);border-top-left-radius:12px;border-bottom-left-radius:12px;font-weight:700}
  td.c3{border-right:1px solid var(--grid);border-top-right-radius:12px;border-bottom-right-radius:12px;font-weight:800}
  .tag{display:inline-block;border-radius:8px;padding:4px 8px;font-size:12px;border:1px solid var(--grid);color:var(--muted)}
  .al{background:var(--good);color:#fff;border-radius:10px;padding:4px 8px;font-weight:800}
  .sat{background:var(--warn);color:#111;border-radius:10px;padding:4px 8px;font-weight:800}
  .pctPos{color:var(--good)} .pctNeg{color:var(--bad)}
  .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  details{margin-top:10px}
  details > summary{cursor:pointer;list-style:none;padding:8px 12px;background:var(--card);
                    border:1px solid var(--grid);border-radius:10px;width:max-content}
  .custom-grid{margin-top:10px;display:grid;grid-template-columns:repeat(4,minmax(220px,1fr));gap:10px}
  .custom-grid > div{background:var(--card);border:1px solid var(--grid);border-radius:12px;padding:10px}
  .range{width:100%}
  .pill{display:inline-flex;gap:8px;align-items:center}
  .note{color:var(--muted);font-size:12px}
  .blink{animation:blink 1.2s ease-in-out infinite}
  @keyframes blink{50%{opacity:.55}}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div class="title">MEXC <b>Spot â†” Futures</b> Fark Ä°zleyici (USDT)</div>
      <div id="btcTicker" class="chip" title="MEXC Futures BTC_USDT canlÄ±">
        <span>BTC_USDT</span><b id="btcPx">â€”</b><span class="note">futures</span>
      </div>
      <label class="pill chip"><input id="toggleTop" type="checkbox" checked /> En yÃ¼ksek fark kartÄ±</label>
      <div class="clock" id="clock">â€”:â€”:â€”</div>
    </div>

    <div id="topCard">
      <span class="sym" id="topSym">â€”</span>
      <span id="topAct" class="act">AL</span>
      <span class="price" id="topPrice">â€”</span>
      <span>â€¢</span>
      <span id="topPct" class="pct">%</span>
      <span class="note" id="topHint">SPOT fiyatÄ± & fark</span>
    </div>

    <div class="controls">
      <div>
        <label>Coin ekle (Ã¶rn. <b>ETH</b> veya <b>ETH_USDT</b>)</label>
        <div class="flex">
          <input id="addSym" type="text" placeholder="Sembol..." />
          <button class="btn" id="btnAdd">Ekle</button>
          <button class="btn" id="btnClear">TÃ¼mÃ¼nÃ¼ Sil</button>
        </div>
        <div class="note">Sadece eklediÄŸiniz coinler iÃ§in veri dinlenir.</div>
      </div>
      <div>
        <label>Yenileme hÄ±zÄ± (gÃ¶rsel)</label>
        <select id="speed">
          <option value="100">0.1 sn</option>
          <option value="200">0.2 sn</option>
          <option value="300">0.3 sn</option>
          <option value="500">0.5 sn</option>
          <option value="1000" selected>1 sn</option>
          <option value="2000">2 sn</option>
          <option value="4000">4 sn</option>
        </select>
        <div class="note">WebSocket sÃ¼rekli akar; bu sadece DOM gÃ¼ncelleme sÄ±klÄ±ÄŸÄ±dÄ±r.</div>
      </div>
      <div>
        <label>Fark eÅŸiÄŸi (%)</label>
        <input id="thresh" type="number" step="0.01" value="0.10" />
        <div class="note">Bu yÃ¼zdeyi <u>aÅŸan</u> farklar listelenir.</div>
      </div>
      <div>
        <label>Arka plan</label>
        <select id="theme">
          <option value="dark" selected>Koyu</option>
          <option value="light">Beyaz</option>
        </select>
        <div class="note">SeÃ§iminiz kaydedilir.</div>
      </div>
      <div>
        <label>En Ã§ok fark (AL/SAT) yalnÄ±zca <b>SPOT</b> gÃ¶ster</label>
        <div class="note">Ãœst kartta futures rengi/etiketi gÃ¶sterilmez.</div>
      </div>
      <div>
        <label>Ekstra</label>
        <div class="flex">
          <button class="btn" id="btnExport">Listeyi indir</button>
          <button class="btn" id="btnImport">Liste iÃ§e al</button>
          <input type="file" id="fileImport" accept="application/json" style="display:none" />
        </div>
      </div>
    </div>

    <details id="custom">
      <summary>ğŸ’… TasarÄ±m / KiÅŸiselleÅŸtirme</summary>
      <div class="custom-grid">
        <div>
          <label>SatÄ±r yazÄ± boyutu</label>
          <input id="rowFont" class="range" type="range" min="12" max="28" value="16" />
        </div>
        <div>
          <label>SatÄ±r yÃ¼ksekliÄŸi (dolu/padding)</label>
          <input id="dense" class="range" type="range" min="4" max="20" value="10" />
        </div>
        <div>
          <label>BaÅŸlÄ±k yazÄ± boyutu</label>
          <input id="headerSize" class="range" type="range" min="14" max="28" value="18" />
        </div>
        <div>
          <label>Tablo Ã¶lÃ§ek (zoom)</label>
          <input id="scale" class="range" type="range" min="0.8" max="1.3" step="0.01" value="1" />
        </div>
      </div>
    </details>
  </div>
</header>

<main class="wrap">
  <table id="tbl">
    <thead>
      <tr>
        <th>Coin</th>
        <th>AL (Spot)</th>
        <th>SAT (Futures)</th>
        <th>Fark / YÃ¼zde</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <p class="note" style="margin:14px 2px">
    Not: AnlÄ±k arbitraj yapÄ±labilirliÄŸi; bakiye, izinler, slipaj ve komisyonlara baÄŸlÄ±dÄ±r.
  </p>
</main>

<script>
/* ============ Basit durum ============ */
const S = {
  coins: new Set(),
  spot: new Map(),     // {bid, ask}
  fut: new Map(),      // {bid, ask}
  rows: [],
  ui: {
    speed: +(localStorage.getItem('speed') || 1000),
    thresh: +(localStorage.getItem('thresh') || 0.10),
    theme: localStorage.getItem('theme') || 'dark',
    rowFont: +(localStorage.getItem('rowFont') || 16),
    dense: +(localStorage.getItem('dense') || 10),
    header: +(localStorage.getItem('header') || 18),
    scale: +(localStorage.getItem('scale') || 1),
    top: JSON.parse(localStorage.getItem('top') || 'true')
  },
  conns: { spot: [], fut: null },
  maxPerWS: 28, // gÃ¼venli limit (MEXC spot: 30 yazÄ±yor)
};

/* ============ YardÄ±mcÄ±lar ============ */
const $ = sel => document.querySelector(sel);
const fmt = (n, d=4) => (isFinite(n)? (+n).toFixed(d) : 'â€”');
const pct = (p) => (isFinite(p)? (p>=0? '+' : '') + p.toFixed(3)+'%' : 'â€”');
const nowStr = ()=> new Date().toLocaleTimeString('tr-TR', {hour12:false});

function saveState(){
  localStorage.setItem('coins', JSON.stringify([...S.coins]));
  localStorage.setItem('speed', S.ui.speed);
  localStorage.setItem('thresh', S.ui.thresh);
  localStorage.setItem('theme', S.ui.theme);
  localStorage.setItem('rowFont', S.ui.rowFont);
  localStorage.setItem('dense', S.ui.dense);
  localStorage.setItem('header', S.ui.header);
  localStorage.setItem('scale', S.ui.scale);
  localStorage.setItem('top', S.ui.top);
}
function loadState(){
  try{
    const arr = JSON.parse(localStorage.getItem('coins')||'[]');
    arr.forEach(sym=> S.coins.add(sym));
  }catch{}
}

/* ============ Protobuf minimal decoder (sadece gereken alanlar) ============ */
/* PushDataV3ApiWrapper.proto:
   1: channel (string, wt=2)
   oneof body: 305: publicBookTicker (msg), 315: publicAggreBookTicker (msg)
   3: symbol (string), 4: symbolId (string), 5: createTime (varint), 6: sendTime (varint)
   Public(Book/Aggre)TickerV3Api:
   1: bidPrice (string) 2: bidQuantity (string) 3: askPrice (string) 4: askQuantity (string)
*/
function readVarint(u8, i){
  let x=0n, s=0n, pos=i;
  while(true){
    const b=u8[pos++];
    x |= BigInt(b & 0x7f) << s;
    if(!(b & 0x80)) break;
    s += 7n;
  }
  return [Number(x), pos];
}
function readBytes(u8, i, len){ return [u8.slice(i, i+len), i+len]; }
function readString(u8, i){
  let len; [len,i]=readVarint(u8,i);
  let bytes = u8.slice(i,i+len); i+=len;
  return [new TextDecoder().decode(bytes), i];
}
function skip(u8, i, wireType){
  if(wireType===0){ let _; [_,i]=readVarint(u8,i); return i; }
  if(wireType===1){ return i+8; }
  if(wireType===2){ let len; [len,i]=readVarint(u8,i); return i+len; }
  if(wireType===5){ return i+4; }
  return i;
}
function decodeBookTicker(u8){
  let i=0, out={};
  while(i<u8.length){
    let key; [key,i]=readVarint(u8,i);
    const field=key>>3, wt=key&7;
    if(wt===2){
      if(field===1){ let s; [s,i]=readString(u8,i); out.bidPrice=s; }
      else if(field===2){ let s; [s,i]=readString(u8,i); out.bidQuantity=s; }
      else if(field===3){ let s; [s,i]=readString(u8,i); out.askPrice=s; }
      else if(field===4){ let s; [s,i]=readString(u8,i); out.askQuantity=s; }
      else { let len; [len,i]=readVarint(u8,i); i+=len; }
    } else { i = skip(u8,i,wt); }
  }
  return out;
}
function decodeWrapper(arrayBuf){
  const u8 = new Uint8Array(arrayBuf);
  let i=0, out={ channel:null, symbol:null, book:null };
  while(i<u8.length){
    let key; [key,i]=readVarint(u8,i);
    const field=key>>3, wt=key&7;
    if(field===1 && wt===2){ let s; [s,i]=readString(u8,i); out.channel=s; }
    else if((field===305 || field===315) && wt===2){
      let len; [len,i]=readVarint(u8,i);
      const bytes = u8.slice(i,i+len); i+=len;
      out.book = decodeBookTicker(bytes);
    }
    else if(field===3 && wt===2){ let s; [s,i]=readString(u8,i); out.symbol=s; }
    else if(wt===2){ let len; [len,i]=readVarint(u8,i); i+=len; }
    else if(wt===0){ let _; [_,i]=readVarint(u8,i); }
    else if(wt===1){ i+=8; }
    else if(wt===5){ i+=4; }
  }
  return out;
}

/* ============ WebSocket yÃ¶neticileri ============ */
// SPOT (protobuf): wss://wbs-api.mexc.com/ws , channel: spot@public.aggre.bookTicker.v3.api.pb@100ms@SYMBOL
class SpotWS {
  constructor(){ this.ws=null; this.syms=new Set(); this.alive=false; this.timer=null; }
  connect(){
    this.ws = new WebSocket('wss://wbs-api.mexc.com/ws');
    this.ws.binaryType = 'arraybuffer';
    this.ws.onopen = () => {
      this.alive = true;
      this.ping();
      // yeniden abone ol
      if(this.syms.size) this.subscribeBulk([...this.syms]);
    };
    this.ws.onmessage = (ev)=>{
      if(typeof ev.data === 'string'){
        // sub ack / pong vs
        // ignore or log
      }else{
        const msg = decodeWrapper(ev.data);
        if(msg?.book && (msg.symbol || this._extractSymbol(msg.channel))){
          const sym = (msg.symbol || this._extractSymbol(msg.channel));
          const bid = parseFloat(msg.book.bidPrice);
          const ask = parseFloat(msg.book.askPrice);
          if(isFinite(bid) && isFinite(ask)) S.spot.set(sym,{bid,ask,ts:Date.now()});
        }
      }
    };
    this.ws.onclose = () => { this.alive=false; setTimeout(()=>this.connect(), 1000); };
    this.ws.onerror = () => { try{this.ws.close();}catch{} };
  }
  _extractSymbol(channel){
    // channel Ã¶rn: spot@public.aggre.bookTicker.v3.api.pb@100ms@BTCUSDT
    if(!channel) return null;
    const parts = String(channel).split('@');
    return parts[parts.length-1] || null;
  }
  ping(){
    clearInterval(this.timer);
    this.timer = setInterval(()=>{
      try{ this.ws?.readyState===1 && this.ws.send(JSON.stringify({method:"PING"})); }catch{}
    }, 20000);
  }
  subscribe(sym){
    this.syms.add(sym);
    if(this.ws?.readyState===1){
      this.ws.send(JSON.stringify({method:"SUBSCRIPTION", params:[`spot@public.aggre.bookTicker.v3.api.pb@100ms@${sym.replace('_','')}`]}));
    }
  }
  unsubscribe(sym){
    this.syms.delete(sym);
    if(this.ws?.readyState===1){
      this.ws.send(JSON.stringify({method:"UNSUBSCRIPTION", params:[`spot@public.aggre.bookTicker.v3.api.pb@100ms@${sym.replace('_','')}`]}));
    }
  }
  subscribeBulk(list){
    // 30 sÄ±nÄ±rÄ± sebebiyle zaten havuz yapacaÄŸÄ±z; bu sÄ±nÄ±f tek WS iÃ§in.
    list.forEach(sym=>this.subscribe(sym));
  }
}
// FUTURES (JSON): wss://contract.mexc.com/edge , method: sub.ticker {symbol:"BTC_USDT"}
class FuturesWS {
  constructor(){ this.ws=null; this.syms=new Set(); this.timer=null; }
  connect(){
    this.ws = new WebSocket('wss://contract.mexc.com/edge');
    this.ws.onopen = ()=>{
      this.ping();
      if(this.syms.size) this.subscribeBulk([...this.syms]);
    };
    this.ws.onmessage = (ev)=>{
      try{
        const j = JSON.parse(ev.data);
        if(j.channel==="push.ticker" && j.data && j.symbol){
          const sym=j.symbol;
          const bid = +j.data.bid1;
          const ask = +j.data.ask1;
          if(isFinite(bid) && isFinite(ask)) S.fut.set(sym,{bid,ask,ts:Date.now()});
          if(sym==="BTC_USDT"){
            $('#btcPx').textContent = fmt(+j.data.lastPrice,2)+" USDT";
            $('#btcTicker').classList.add('blink'); setTimeout(()=>$('#btcTicker').classList.remove('blink'), 200);
          }
        }else if(j.channel==="pong"){ /* ok */ }
      }catch{}
    };
    this.ws.onclose = ()=> setTimeout(()=>this.connect(), 1000);
    this.ws.onerror = ()=> { try{this.ws.close();}catch{} };
  }
  ping(){
    clearInterval(this.timer);
    this.timer = setInterval(()=>{
      try{ this.ws?.readyState===1 && this.ws.send(JSON.stringify({method:"ping"})); }catch{}
    }, 20000);
  }
  subscribe(sym){
    this.syms.add(sym);
    if(this.ws?.readyState===1){
      this.ws.send(JSON.stringify({method:"sub.ticker", param:{symbol:sym}}));
    }
  }
  unsubscribe(sym){
    this.syms.delete(sym);
    if(this.ws?.readyState===1){
      this.ws.send(JSON.stringify({method:"unsub.ticker", param:{symbol:sym}}));
    }
  }
  subscribeBulk(list){ list.forEach(sym=>this.subscribe(sym)); }
}

/* ============ WS havuzu (spot iÃ§in 30 sÄ±nÄ±rÄ±) ============ */
function ensureSpotConnForIndex(idx){
  const pool = S.conns.spot;
  const wsIdx = Math.floor(idx / S.maxPerWS);
  while(pool.length <= wsIdx){
    const ws = new SpotWS(); ws.connect(); pool.push(ws);
  }
  return pool[wsIdx];
}
function addSymbol(sym){
  sym = normalize(sym);
  if(S.coins.has(sym)) return;
  const idx = S.coins.size;
  S.coins.add(sym);
  ensureSpotConnForIndex(idx).subscribe(sym);
  if(!S.conns.fut){ S.conns.fut = new FuturesWS(); S.conns.fut.connect(); }
  S.conns.fut.subscribe(sym);
  saveState();
  blinkTop();
}
function removeSymbol(sym){
  sym = normalize(sym);
  if(!S.coins.has(sym)) return;
  const list = [...S.coins];
  const idx = list.indexOf(sym);
  // yeniden daÄŸÄ±tÄ±m basit olsun: tÃ¼mÃ¼nÃ¼ kapatÄ±p yeniden kurmak yerine ilgili baÄŸlantÄ±lardan unsub
  S.conns.spot.forEach(ws=> ws.unsubscribe(sym));
  S.conns.fut?.unsubscribe(sym);
  S.coins.delete(sym);
  saveState();
}
function normalize(x){
  x = x.trim().toUpperCase();
  if(!x.includes('_')) x = x+'_USDT';
  x = x.replace(/[^A-Z0-9_]/g,'');
  return x;
}

/* ============ Tablo oluÅŸturma ============ */
function computeRows(){
  const rows=[];
  for(const sym of S.coins){
    const sp = S.spot.get(sym.replace('_','')) || S.spot.get(sym) || null; // wrapper bazen BTCUSDT sembol
    const fu = S.fut.get(sym) || null;
    if(!sp || !fu) continue;
    const diff1 = fu.bid - sp.ask;             // spot AL + futures short
    const pct1  = diff1 / sp.ask * 100;
    const diff2 = sp.bid - fu.ask;             // spot SAT + futures long (stok gerekir)
    const pct2  = diff2 / fu.ask * 100;
    if(pct1<=0 && pct2<=0) continue;

    let lowPrice, highPrice, pct, act, actPrice;
    if(pct1 >= pct2){
      lowPrice = sp.ask; highPrice = fu.bid; pct = pct1; act = 'AL'; actPrice = sp.ask;
    }else{
      lowPrice = fu.ask; highPrice = sp.bid; pct = pct2; act = 'SAT'; actPrice = sp.bid;
    }
    if(pct >= S.ui.thresh){
      rows.push({sym, low:lowPrice, high:highPrice, pct, act, actPrice});
    }
  }
  rows.sort((a,b)=> b.pct - a.pct);
  S.rows = rows;
}
function render(){
  computeRows();
  // Ã¼st kart
  const card = $('#topCard');
  if(!S.ui.top || S.rows.length===0){ card.classList.add('hidden'); }
  else{
    card.classList.remove('hidden');
    const r = S.rows[0];
    $('#topSym').textContent = r.sym.split('_')[0];
    $('#topAct').textContent = r.act; // sadece SPOT eylemi (AL/SAT)
    $('#topPrice').textContent = fmt(r.actPrice, 4)+' USDT';
    $('#topPct').textContent = pct(r.pct);
    $('#topHint').textContent = 'SPOT';
    card.classList.add('blink'); setTimeout(()=>card.classList.remove('blink'), 150);
  }

  // tablo
  const tb = $('#tbody'); tb.innerHTML='';
  for(const r of S.rows){
    const tr = document.createElement('tr');
    const td0 = document.createElement('td'); td0.className='c0 c'; td0.textContent = r.sym;
    const td1 = document.createElement('td');
    td1.innerHTML = `<span class="al">AL</span> ${fmt(r.low,4)}`;
    const td2 = document.createElement('td');
    td2.innerHTML = `<span class="sat">SAT</span> ${fmt(r.high,4)}`;
    const td3 = document.createElement('td'); td3.className='c3';
    const cls = r.pct>=0? 'pctPos':'pctNeg';
    td3.innerHTML = `<b class="${cls}">${pct(r.pct)}</b>`;
    [td0,td1,td2,td3].forEach((td,i)=> td.classList.add('c'+i));
    tr.append(td0,td1,td2,td3);
    tb.appendChild(tr);
  }
}

/* ============ UI baÄŸlama ============ */
function applyTheme(){
  document.body.classList.toggle('light', S.ui.theme==='light');
  document.documentElement.style.setProperty('--rowFont', S.ui.rowFont+'px');
  document.documentElement.style.setProperty('--dense', S.ui.dense+'px');
  document.documentElement.style.setProperty('--header', S.ui.header+'px');
  document.documentElement.style.setProperty('--scale', S.ui.scale);
}
$('#btnAdd').onclick = ()=>{
  const v = $('#addSym').value.trim();
  if(!v) return;
  addSymbol(v);
  $('#addSym').value='';
  render();
};
$('#btnClear').onclick = ()=>{
  if(!confirm('TÃ¼m coinleri silmek istiyor musunuz?')) return;
  [...S.coins].forEach(sym=> removeSymbol(sym));
  render();
};
$('#speed').onchange = (e)=>{ S.ui.speed = +e.target.value; saveState(); restartTicker(); };
$('#thresh').onchange = (e)=>{ S.ui.thresh = +e.target.value; saveState(); render(); };
$('#theme').onchange = (e)=>{ S.ui.theme = e.target.value; saveState(); applyTheme(); };
$('#toggleTop').onchange = (e)=>{ S.ui.top = e.target.checked; saveState(); render(); };

$('#rowFont').oninput = e=>{ S.ui.rowFont=+e.target.value; saveState(); applyTheme(); };
$('#dense').oninput = e=>{ S.ui.dense=+e.target.value; saveState(); applyTheme(); };
$('#headerSize').oninput = e=>{ S.ui.header=+e.target.value; saveState(); applyTheme(); };
$('#scale').oninput = e=>{ S.ui.scale=+e.target.value; saveState(); applyTheme(); };

$('#btnExport').onclick = ()=>{
  const data = JSON.stringify({coins:[...S.coins]}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'mexc-coins.json';
  a.click(); URL.revokeObjectURL(a.href);
};
$('#btnImport').onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = async (e)=>{
  const file = e.target.files?.[0]; if(!file) return;
  const txt = await file.text();
  try{
    const obj = JSON.parse(txt);
    if(Array.isArray(obj.coins)){
      obj.coins.forEach(s=> addSymbol(s));
      render();
    }
  }catch(err){ alert('GeÃ§ersiz dosya'); }
};

/* canlÄ± saat */
setInterval(()=> $('#clock').textContent = nowStr(), 1000);
function restartTicker(){ clearInterval(window.__uiTimer); window.__uiTimer = setInterval(render, S.ui.speed); }

/* ufak anim */
function blinkTop(){ const el = $('#topCard'); el.classList.add('blink'); setTimeout(()=> el.classList.remove('blink'), 200); }

/* ============ BaÅŸlat ============ */
(function init(){
  loadState();
  // tema ve kontrolleri yÃ¼kle
  $('#speed').value = String(S.ui.speed);
  $('#thresh').value = String(S.ui.thresh);
  $('#theme').value = S.ui.theme;
  $('#toggleTop').checked = !!S.ui.top;
  $('#rowFont').value = S.ui.rowFont;
  $('#dense').value = S.ui.dense;
  $('#headerSize').value = S.ui.header;
  $('#scale').value = S.ui.scale;
  applyTheme();

  // WS kurulum: spot havuzu ilk baÄŸlantÄ±, futures baÄŸlantÄ±sÄ±
  ensureSpotConnForIndex(0);
  S.conns.fut = new FuturesWS(); S.conns.fut.connect();

  // kaydedilmiÅŸ coinleri abone et
  [...S.coins].forEach((sym, i)=>{
    ensureSpotConnForIndex(i).subscribe(sym);
    S.conns.fut.subscribe(sym);
  });

  // her durumda BTC_USDT futures gÃ¶ster
  S.conns.fut.subscribe('BTC_USDT');

  restartTicker();
  render();
})();
</script>
</body>
</html>
