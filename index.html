<!DOCTYPE html>
<html lang="tr" class="theme-dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Arbitraj Radarı — Paribu API ⇄ Binance (TL)</title>
<link rel="preconnect" href="https://api.paribu.com">
<link rel="preconnect" href="https://api.binance.com">
<style>
  /* ===== Temalar ===== */
  .theme-dark{
    --bg:#0b1220; --panel:#111a2b; --panel2:#0f1626; --text:#e6edf6;
    --muted:#9fb0ca; --accent:#60a5fa; --border:#17243e;
    --headerStart:#0e172a; --headerEnd:#0b1220;
    --chipBg:#1a243e; --chipBorder:#2a3d64;
    --greenBg:#0f2a1b; --greenBd:#184a2b; --greenTx:#b6f7c8;
    --orangeBg:#2b1a0f; --orangeBd:#4a2b18; --orangeTx:#ffd7a6;
    --redBg:#2b0f12; --redBd:#4a181d; --redTx:#ffb5c0;
  }
  .theme-light{
    --bg:#ffffff; --panel:#f3f6fb; --panel2:#ffffff; --text:#0b1220;
    --muted:#4a5568; --accent:#2563eb; --border:#d7deea;
    --headerStart:#eaf1ff; --headerEnd:#ffffff;
    --chipBg:#eef3ff; --chipBorder:#c8d6f5;
    --greenBg:#e9f8ef; --greenBd:#b9e5c8; --greenTx:#166534;
    --orangeBg:#fff7ed; --orangeBd:#fed7aa; --orangeTx:#7c2d12;
    --redBg:#fee2e2; --redBd:#fecaca; --redTx:#7f1d1d;
  }

  /* ===== Kişiselleştirme ===== */
  :root{
    --table-font:18px;
    --cell-pad-y:12px;
    --cell-pad-x:10px;
    --row-gap:6px;
    --cell-radius:12px;
    --container-max:1100px;
    --col-coin:28%;
    --col-al:27%;
    --col-sat:27%;
    --col-pct:18%;
    --card-font:22px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(180deg,var(--headerStart),var(--headerEnd));border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:20px}
  header .sub{color:var(--muted);font-size:12px}
  header .rightBox{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .btn{background:var(--accent);color:#091220;border:none;border-radius:10px;padding:10px 12px;font-weight:700;cursor:pointer}
  .ghost{background:var(--panel);color:var(--text);border:1px solid var(--border)}
  .danger{background:var(--redBg);color:var(--redTx);border:1px solid var(--redBd)}
  .ok{background:var(--greenBg);color:var(--greenTx);border:1px solid var(--greenBd)}
  .warn{background:var(--orangeBg);color:var(--orangeTx);border:1px solid var(--orangeBd)}

  /* Highlight */
  .hiWrap{padding:10px 16px}
  .hidden{display:none}
  .hiLine{
    font-size:var(--card-font);font-weight:800;letter-spacing:.2px;
    background:var(--panel2);border:1px solid var(--border);
    border-left:6px solid #22c55e;border-radius:14px;padding:10px 14px;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap
  }
  .hiPill{background:var(--greenBg);border:1px solid var(--greenBd);color:var(--greenTx);
    border-radius:999px;padding:4px 10px;font-weight:800}

  /* Kontroller */
  .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;padding:12px 16px;background:var(--panel);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  .ctrl{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px}
  .ctrl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="text"],input[type="number"],select{
    width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);
    border-radius:10px;padding:10px 12px;font-size:14px;outline:none
  }
  input[type="range"]{width:100%}
  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:999px;padding:5px 10px;font-size:12px}
  .chip button{all:unset;cursor:pointer;color:#4f79ff}

  /* Tablo */
  .tableWrap{padding:12px 16px;max-width:var(--container-max);margin:0 auto}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--row-gap);table-layout:fixed}
  thead th{font-size:calc(var(--table-font) - 4px);color:var(--muted);text-align:center;padding:0 8px}
  thead th:first-child{text-align:left}
  tbody tr{background:var(--panel2);border:1px solid var(--border)}
  tbody td{padding:var(--cell-pad-y) var(--cell-pad-x);font-size:var(--table-font)}
  tbody tr td:first-child{border-top-left-radius:var(--cell-radius);border-bottom-left-radius:var(--cell-radius)}
  tbody tr td:last-child{border-top-right-radius:var(--cell-radius);border-bottom-right-radius:var(--cell-radius)}
  .mono{font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .coinCell{display:flex;align-items:center;gap:10px;font-weight:800}
  .alCell,.satCell,.pctCell{text-align:center;font-weight:800}

  /* Kişiselleştirme */
  .customWrap{padding:10px 16px}
  .customPanel{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:14px;display:grid;gap:12px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .kv{display:flex;align-items:center;gap:8px}
  .kv .val{font-size:12px;color:var(--muted);min-width:48px;text-align:right}
  .footerBtns{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div>
    <h1>Arbitraj Radarı — Paribu API ⇄ Binance (TL)</h1>
    <div class="sub">
      <span id="usdBox">USDT→TRY: <span id="usdtry" class="mono">—</span></span>
      · Son: <span id="last" class="mono">—</span>
      · <span id="modeLbl" class="mono">REST</span>
    </div>
  </div>
  <div class="rightBox">
    <div class="sub">BTCUSDT: <span id="btc" class="mono">—</span></div>
    <button id="toggleHi" class="btn ghost">En Yüksek Fark: Açık</button>
    <button id="toggleWs" class="btn ghost">Hızlı Mod (WS): Kapalı</button>
    <button id="toggleCustom" class="btn ghost">Kişiselleştir: Kapalı</button>
    <div class="sub">İzlenen: <span id="cnt">0</span> · Hata: <span id="err">0</span> · RL: <span id="rl">—</span></div>
  </div>
</header>

<!-- Highlight -->
<div id="anchorTop"></div>
<section id="hiWrap" class="hiWrap">
  <div class="hiLine">
    <span id="hiCoin">—</span>
    <span class="hiPill" id="hiAct">PARİBU • —</span>
    <span id="hiPrice" class="mono">—</span>
    <span id="hiPct" class="mono">—</span>
  </div>
</section>

<!-- Kontroller -->
<section class="controls">
  <div class="ctrl">
    <label>Coin Ekle / Çıkar</label>
    <div class="row">
      <input id="coinIn" type="text" placeholder="Örn: ZIL, XAI, MINA"/>
      <button id="add" class="btn">Ekle</button>
      <button id="clear" class="btn ghost">Temizle</button>
    </div>
    <div id="chips" class="chips"></div>
  </div>

  <div class="ctrl">
    <label>Yenileme Aralığı (0.1–4.0 sn)</label>
    <div class="row">
      <input id="rng" type="range" min="100" max="4000" step="100">
      <div class="mono" id="rngLbl">—</div>
    </div>
    <div class="sub">REST modunda geçerli. WS modunda sadece çizim periyodu.</div>
  </div>

  <div class="ctrl">
    <label>Min. % Fark (filtre)</label>
    <div class="row">
      <input id="minPct" type="number" step="0.01" min="0" value="0.00"/>
    </div>
    <div class="sub">Bu eşiğin altı listelenmez.</div>
  </div>

  <div class="ctrl">
    <label>Tema</label>
    <div class="row">
      <select id="themeSel">
        <option value="dark">Koyu</option>
        <option value="light">Açık</option>
      </select>
    </div>
  </div>
</section>

<section class="tableWrap">
  <table>
    <colgroup>
      <col style="width:var(--col-coin);">
      <col style="width:var(--col-al);">
      <col style="width:var(--col-sat);">
      <col style="width:var(--col-pct);">
    </colgroup>
    <thead>
      <tr>
        <th style="text-align:left">Coin</th>
        <th>AL</th>
        <th>SAT</th>
        <th>% Fark</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<script>
/* ===================== Yardımcılar & Depo ===================== */
const $ = s => document.querySelector(s);
const LS = {
  get(k, d){ try{ const v = localStorage.getItem(k); return v==null? d : JSON.parse(v);}catch{return d;} },
  set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} }
};
function norm(sym){
  if(!sym) return '';
  return sym.trim().toUpperCase()
    .replaceAll('İ','I').replaceAll('İ','I')
    .replaceAll('Ç','C').replaceAll('Ğ','G').replaceAll('Ö','O').replaceAll('Ş','S').replaceAll('Ü','U');
}
const fmt = {
  f(n,d=2){ return (n==null||!isFinite(n)) ? '—' : Number(n).toLocaleString('tr-TR',{minimumFractionDigits:d,maximumFractionDigits:d}); },
  p(n,d=2){ return (n==null||!isFinite(n)) ? '—' : '%'+Number(n).toLocaleString('tr-TR',{minimumFractionDigits:d,maximumFractionDigits:d}); },
  four(n){ return (n==null||!isFinite(n)) ? '—' : Number(n).toFixed(4); },
  now(){ return new Date().toLocaleTimeString('tr-TR'); }
};

/* ===================== API Sabitleri ===================== */
const PARIBU_REST = 'https://api.paribu.com';
const PARIBU_WS   = 'wss://stream.paribu.com';
const BINANCE_BOOK_ALL = 'https://api.binance.com/api/v3/ticker/bookTicker';
const BINANCE_BTC_PRICE = 'https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT';

/* ===================== Durum ===================== */
let watched = new Set(LS.get('arbi2:watched', []));
let refreshMs = Number(LS.get('arbi2:interval', 1000));
let minPctFilter = Number(LS.get('arbi2:minpct', 0.00));
let themeMode = LS.get('arbi2:theme', 'dark');
let hiOn = LS.get('arbi2:hiOn', true);
let wsMode = LS.get('arbi2:wsMode', false);

let restBackoffUntil = 0; // ms epoch
let errors=0, binanceMap = new Map(), paribuMap = new Map(); // sym -> {bid,ask}
let usdtry = null;

const elUsd = $('#usdtry'), elLast=$('#last'), elCnt=$('#cnt'), elErr=$('#err'), elRL=$('#rl'),
      elBody=$('#tbody'), elRngLbl=$('#rngLbl'), elRng=$('#rng'),
      elMin=$('#minPct'), elThemeSel=$('#themeSel'), elBTC=$('#btc'),
      elHiWrap=$('#hiWrap'), elHiCoin=$('#hiCoin'), elHiAct=$('#hiAct'),
      elHiPrice=$('#hiPrice'), elHiPct=$('#hiPct'), elModeLbl=$('#modeLbl');

/* ===================== Ağ yardımcıları ===================== */
async function jget(url){
  // Not: CORS sorunu yaşarsanız bu çağrıyı kendi mini proxy’nizden geçirin.
  const res = await fetch(url, {cache:'no-store'});
  // Rate-limit header’larını takip et
  const consumed = res.headers.get('X-RateLimit-Consumed');
  if(consumed) elRL.textContent = consumed;
  if(res.status === 429){
    // Retry-After (saniye) gelebilir
    const ra = Number(res.headers.get('Retry-After')) || 1;
    restBackoffUntil = Date.now() + ra*1000;
    throw new Error('RATE_LIMIT_429');
  }
  if(!res.ok) throw new Error('HTTP_'+res.status);
  return res.json();
}

function parseParibuRest(ob){
  if(!ob || !Array.isArray(ob.bids) || !Array.isArray(ob.asks)) return {bid:NaN, ask:NaN};
  const bid = ob.bids.length ? parseFloat(ob.bids[0][0]) : NaN;
  const ask = ob.asks.length ? parseFloat(ob.asks[0][0]) : NaN;
  return {bid, ask};
}

function paribuOrderbookUrl(sym){ // "BTC" -> market=btc_tl
  const mkt = sym.toLowerCase()+'_tl';
  return `${PARIBU_REST}/orderbook?market=${mkt}&depth=1`;
}

/* ===================== Binance (toplu) ===================== */
let lastBinanceFetch = 0, BINANCE_REFRESH_MS = 1000;
async function refreshBinance(){
  const now = Date.now();
  if(now - lastBinanceFetch < BINANCE_REFRESH_MS) return;
  lastBinanceFetch = now;
  try{
    const arr = await jget(BINANCE_BOOK_ALL); // Tüm semboller
    // Sadece ihtiyacımız olanları ayıkla
    const need = new Set([...watched].map(s => s+'USDT'));
    for(const o of arr){
      if(need.has(o.symbol)){
        const bid = parseFloat(o.bidPrice), ask = parseFloat(o.askPrice);
        binanceMap.set(o.symbol.replace('USDT',''), {bid, ask});
      }
    }
    // BTC fiyat kutusu
    const btc = arr.find(x => x.symbol === 'BTCUSDT');
    if(btc){
      const p = parseFloat(btc.askPrice);
      if(isFinite(p)) elBTC.textContent = fmt.f(p,2);
    }
  }catch(e){ /* Binance hataları global sayaçta tutmuyoruz */ }
}

/* ===================== Paribu WebSocket (opsiyonel) ===================== */
let ws=null, wsConnected=false, wsSubs=new Set();
function wsConnect(){
  if(ws) try{ ws.close(); }catch{}
  ws = new WebSocket(PARIBU_WS);
  ws.onopen = ()=>{
    wsConnected = true;
    wsSubs.clear();
    const chans = [...watched].map(s => `orderbook:${s.toLowerCase()}_tl@100ms`);
    chans.push('orderbook:usdt_tl@100ms'); // kur
    const msg = { method:'subscribe', channels:chans, id:'req_'+Date.now() };
    ws.send(JSON.stringify(msg));
    chans.forEach(c=>wsSubs.add(c));
  };
  ws.onmessage = (ev)=>{
    try{
      const m = JSON.parse(ev.data);
      if(m && m.e === 'orderbook' && m.s){
        const mkt = m.s; // "btc_tl"
        const base = mkt.split('_')[0].toUpperCase();
        const bid = m.r?.b?.[0]?.[0] ? parseFloat(m.r.b[0][0]) : NaN;
        const ask = m.r?.a?.[0]?.[0] ? parseFloat(m.r.a[0][0]) : NaN;
        if(mkt === 'usdt_tl'){ // kur
          if(isFinite(bid)) usdtry = bid;
          elUsd.textContent = fmt.f(usdtry,4);
        }else{
          paribuMap.set(base, {bid, ask});
        }
      }
    }catch{}
  };
  ws.onclose = ()=>{ wsConnected=false; setTimeout(()=>{ if(wsMode) wsConnect(); }, 1000); };
  ws.onerror = ()=>{ /* otomatik close tetiklenir */ };
}

/* ===================== İş mantığı ===================== */
function pickRows(){
  const rows=[];
  const syms = [...watched];
  for(const sym of syms){
    const p = paribuMap.get(sym);
    const b = binanceMap.get(sym);
    if(!p || !b || !isFinite(p.bid) || !isFinite(p.ask) || !isFinite(b.bid) || !isFinite(b.ask) || !isFinite(usdtry)) continue;

    // Binance’den al (USDT), Paribu’da sat (TL)
    const bAskTL = b.ask * usdtry;
    const diff1 = p.bid - bAskTL;
    const pct1 = diff1 / bAskTL * 100;

    // Paribu’dan al (TL), Binance’de sat (USDT)
    const bBidTL = b.bid * usdtry;
    const diff2 = bBidTL - p.ask;
    const pct2 = diff2 / p.ask * 100;

    let show=false, low=0, high=0, pct=0, paribuAction=null, paribuPrice=null;
    if(diff1>0 || diff2>0){
      show=true;
      if(diff1>diff2){
        pct=pct1; low=bAskTL; high=p.bid; paribuAction='SAT'; paribuPrice=p.bid;
      }else{
        pct=pct2; low=p.ask; high=bBidTL; paribuAction='AL'; paribuPrice=p.ask;
      }
    }
    if(show && pct >= (Number(minPctFilter)||0)){
      rows.push({sym, low, high, pct, paribuAction, paribuPrice,
                 lowSrc: (low===bAskTL?'Binance':'Paribu'),
                 highSrc:(high===p.bid?'Paribu':'Binance')});
    }
  }
  rows.sort((a,b)=> b.pct - a.pct);
  return rows;
}

function draw(rows){
  const frag=document.createDocumentFragment();
  for(const r of rows){
    const tr=document.createElement('tr');

    const tdC=document.createElement('td'); tdC.className='coinCell'; tdC.textContent=r.sym; tr.appendChild(tdC);

    const tdL=document.createElement('td'); tdL.className='mono alCell';
    tdL.textContent=fmt.four(r.low);
    tdL.title = (r.lowSrc==='Binance'?'Binance (USDT→TL) AL':'Paribu AL');
    tdL.style.background = (r.lowSrc==='Binance') ? 'var(--orangeBg)' : 'var(--greenBg)';
    tdL.style.border = '1px solid ' + (r.lowSrc==='Binance'?'var(--orangeBd)':'var(--greenBd)');
    tr.appendChild(tdL);

    const tdH=document.createElement('td'); tdH.className='mono satCell';
    tdH.textContent=fmt.four(r.high);
    tdH.title = (r.highSrc==='Paribu'?'Paribu SAT':'Binance (USDT) SAT');
    tdH.style.background = (r.highSrc==='Paribu') ? 'var(--greenBg)' : 'var(--orangeBg)';
    tdH.style.border = '1px solid ' + (r.highSrc==='Paribu'?'var(--greenBd)':'var(--orangeBd)');
    tr.appendChild(tdH);

    const tdP=document.createElement('td'); tdP.className='mono pctCell';
    tdP.textContent=fmt.p(r.pct,2);
    tr.appendChild(tdP);

    frag.appendChild(tr);
  }
  elBody.innerHTML='';
  elBody.appendChild(frag);
}

function updateHighlight(rows){
  if(!hiOn){ elHiWrap.classList.add('hidden'); return; }
  elHiWrap.classList.remove('hidden');
  if(!rows.length){
    elHiCoin.textContent='—'; elHiAct.textContent='PARİBU • —';
    elHiPrice.textContent='—'; elHiPct.textContent='—'; return;
  }
  const r=rows[0];
  elHiCoin.textContent=r.sym;
  elHiAct.textContent='PARİBU • '+(r.paribuAction==='AL'?'AL':'SAT');
  elHiPrice.textContent=fmt.f(r.paribuPrice,2)+' TL';
  elHiPct.textContent=fmt.p(r.pct,2);
}

/* ===================== REST döngüsü ===================== */
async function tickREST(){
  // Rate-limit backoff
  if(Date.now() < restBackoffUntil){ elLast.textContent=fmt.now(); return; }

  try{
    // kur (USDT→TRY)
    const usdt = await jget(paribuOrderbookUrl('USDT'));
    const k = parseParibuRest(usdt);
    if(isFinite(k.bid)) usdtry = k.bid;
    elUsd.textContent = fmt.f(usdtry,4);

    // Paribu orderbook’ları paralel
    const syms=[...watched];
    const jobs = syms.map(async s=>{
      const ob = await jget(paribuOrderbookUrl(s));
      const best = parseParibuRest(ob);
      paribuMap.set(s, best);
    });
    await Promise.allSettled(jobs);

    // Binance toplu bookTicker (harici periyotlu)
    await refreshBinance();

    const rows = pickRows();
    draw(rows);
    updateHighlight(rows);
    elLast.textContent=fmt.now();
  }catch(e){
    if(e && String(e).includes('RATE_LIMIT_429')){
      // backoff zaten ayarlandı
    }else{
      errors++; elErr.textContent=errors;
    }
  }
}

/* ===================== WS çizim döngüsü ===================== */
async function tickWS(){
  try{
    // Kur ve Paribu bestler WS ile akıyor; Binance’i periyodik güncelle
    await refreshBinance();
    const rows = pickRows();
    draw(rows);
    updateHighlight(rows);
    elLast.textContent=fmt.now();
  }catch(e){ errors++; elErr.textContent=errors; }
}

/* ===================== UI ===================== */
function renderChips(){
  const wrap=$('#chips'); wrap.innerHTML='';
  [...watched].sort().forEach(sym=>{
    const d=document.createElement('div'); d.className='chip'; d.innerHTML=`<span>${sym}</span>`;
    const b=document.createElement('button'); b.textContent='×';
    b.onclick=()=>{ watched.delete(sym); LS.set('arbi2:watched',[...watched]); $('#cnt').textContent=watched.size; renderChips(); if(wsMode) wsConnect(); };
    d.appendChild(b); wrap.appendChild(d);
  });
  $('#cnt').textContent=watched.size;
}

function schedule(ms){
  refreshMs = Math.max(100, Math.min(4000, ms|0));
  elRng.value = refreshMs;
  elRngLbl.textContent = (refreshMs/1000).toFixed(1)+' sn';
  LS.set('arbi2:interval', refreshMs);
}

function applyTheme(mode){
  const html=document.documentElement;
  html.classList.remove('theme-dark','theme-light');
  html.classList.add(mode==='light'?'theme-light':'theme-dark');
  $('#themeSel').value = (mode==='light'?'light':'dark');
  LS.set('arbi2:theme', (mode==='light'?'light':'dark'));
}

/* ===================== Eventler ===================== */
$('#add').onclick = ()=>{
  const raw = $('#coinIn').value; const sym=norm(raw);
  if(sym){ watched.add(sym); LS.set('arbi2:watched',[...watched]); renderChips(); if(wsMode) wsConnect(); }
  $('#coinIn').value='';
};
$('#coinIn').addEventListener('keydown', e=>{ if(e.key==='Enter') $('#add').click(); });
$('#clear').onclick = ()=>{
  watched.clear(); LS.set('arbi2:watched',[]); renderChips(); elBody.innerHTML='';
  if(wsMode) wsConnect();
};
elRng.addEventListener('input', e=> schedule(Number(e.target.value)));
elMin.addEventListener('input', e=>{ minPctFilter=Number(e.target.value)||0; LS.set('arbi2:minpct',minPctFilter); });
elThemeSel.addEventListener('change', e=> applyTheme(e.target.value));

$('#toggleHi').onclick = ()=>{
  hiOn=!hiOn; LS.set('arbi2:hiOn',hiOn);
  $('#toggleHi').textContent = 'En Yüksek Fark: '+(hiOn?'Açık':'Kapalı');
  updateHighlight([]);
};

$('#toggleWs').onclick = ()=>{
  wsMode = !wsMode; LS.set('arbi2:wsMode', wsMode);
  $('#toggleWs').textContent = 'Hızlı Mod (WS): ' + (wsMode?'Açık':'Kapalı');
  elModeLbl.textContent = wsMode?'WS':'REST';
  if(wsMode){ wsConnect(); } else { if(ws) try{ws.close();}catch{} }
};

/* ===================== Döngü başlat ===================== */
let timer=null;
function startLoop(){
  if(timer) clearInterval(timer);
  timer = setInterval(()=>{ wsMode ? tickWS() : tickREST(); }, refreshMs);
}

/* ===================== İlk yükleme ===================== */
(function init(){
  applyTheme(themeMode);
  renderChips();
  $('#minPct').value = isFinite(minPctFilter)?minPctFilter:0;
  $('#toggleHi').textContent = 'En Yüksek Fark: ' + (hiOn?'Açık':'Kapalı');
  $('#toggleWs').textContent = 'Hızlı Mod (WS): ' + (wsMode?'Açık':'Kapalı');
  $('#modeLbl').textContent = wsMode?'WS':'REST';
  schedule(isFinite(refreshMs)?refreshMs:1000);
  elLast.textContent = fmt.now();
  // Başlangıç seed (isterseniz yorum satırını açın)
  if(watched.size===0){ watched = new Set(['BTC','ETH','ZIL']); LS.set('arbi2:watched',[...watched]); }
  renderChips();

  // İlk Binance fetch ve döngü
  refreshBinance();
  startLoop();
  if(wsMode) wsConnect();

  // Saat akışı
  setInterval(()=>{ if(!wsMode && watched.size===0) elLast.textContent=fmt.now(); }, 1000);
})();
</script>
</body>
</html>
