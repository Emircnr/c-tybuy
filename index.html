<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Firebase + amCharts Harita Oyunu</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- amCharts 5 Kütüphaneleri -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore.js"></script>

  <style>
    /* Harita tam ekran olacak şekilde ayarlanıyor */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: sans-serif;
    }

    #chartdiv {
      width: 100%;
      height: 100%;
      position: absolute;
    }

    /* Modal içindeki formların biraz boşluklu görünmesi için */
    .modal-body .form-group {
      margin-bottom: 1rem;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Harita Oyunu</span>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" 
            data-bs-target="#navbarSupportedContent" 
            aria-controls="navbarSupportedContent" 
            aria-expanded="false" aria-label="Menüyü Aç/Kapat">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ms-auto">
        <!-- Giriş yapılmamışsa butonlar burada yer alabilir, 
             ancak bu örnekte otomatik modal açıldığı için 
             explicit bir buton kullanmıyoruz.
        -->
        <!-- Kullanıcı giriş yaptıktan sonra gözükecek "Profil" butonu -->
        <li class="nav-item">
          <button class="btn btn-outline-info me-2" 
                  id="profileButton" 
                  style="display: none;"
                  data-bs-toggle="modal" 
                  data-bs-target="#profileModal">
            Profil
          </button>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Harita Konteyneri -->
<div id="chartdiv"></div>

<!-- Kayıt / Giriş Modal -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="authModalLabel">Giriş / Kayıt</h5>
      </div>

      <div class="modal-body">
        <!-- Giriş Formu -->
        <div id="loginForm">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">E-posta</label>
            <input type="email" class="form-control" id="loginEmail" placeholder="Email" />
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Şifre</label>
            <input type="password" class="form-control" id="loginPassword" placeholder="En az 6 karakter" />
          </div>
          <div class="d-grid">
            <button id="loginBtn" class="btn btn-primary">Giriş Yap</button>
          </div>
          <hr />
          <p class="text-center">
            Henüz üye değil misin?
            <button class="btn btn-link p-0" id="showRegisterForm">Kayıt Ol</button>
          </p>
        </div>

        <!-- Kayıt Formu -->
        <div id="registerForm" style="display: none;">
          <div class="mb-3">
            <label for="registerName" class="form-label">Kullanıcı Adı</label>
            <input type="text" class="form-control" id="registerName" placeholder="Kullanıcı Adı" />
          </div>
          <div class="mb-3">
            <label for="registerEmail" class="form-label">E-posta</label>
            <input type="email" class="form-control" id="registerEmail" placeholder="Email" />
          </div>
          <div class="mb-3">
            <label for="registerPassword" class="form-label">Şifre</label>
            <input type="password" class="form-control" id="registerPassword" placeholder="En az 6 karakter" />
          </div>
          <div class="d-grid">
            <button id="registerBtn" class="btn btn-success">Kayıt Ol</button>
          </div>
          <hr />
          <p class="text-center">
            Zaten üyen misin?
            <button class="btn btn-link p-0" id="showLoginForm">Giriş Yap</button>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profil Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Profil Bilgileri</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body">
        <p><strong>Kullanıcı Adı:</strong> <span id="profileName"></span></p>
        <p><strong>E-posta:</strong> <span id="profileEmail"></span></p>
        <p><strong>Bakiye (USDT):</strong> <span id="profileBalance"></span></p>
        <p><strong>Sahip Olduğun Şehirler:</strong> <span id="profileCities"></span></p>
      </div>

      <div class="modal-footer">
        <button id="logoutBtn" class="btn btn-danger">Çıkış Yap</button>
      </div>

    </div>
  </div>
</div>

<!-- Şehir Detay Modal -->
<div class="modal fade" id="cityModal" tabindex="-1" aria-labelledby="cityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-md modal-dialog-centered">
    <div class="modal-content">
      
      <div class="modal-header">
        <h5 class="modal-title" id="cityModalLabel">Şehir Detayı</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>

      <div class="modal-body">
        <p><strong>Şehir:</strong> <span id="cityName"></span></p>
        <p><strong>Fiyat (USDT):</strong> <span id="cityPrice"></span></p>
        <p><strong>Sahibi:</strong> <span id="cityOwner"></span></p>
      </div>

      <div class="modal-footer">
        <button id="buyCityBtn" class="btn btn-success">Satın Al</button>
      </div>

    </div>
  </div>
</div>

<!-- Bootstrap 5 JS (Popper Dahil) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/***************************************************
 * 1) Firebase Konfigürasyon ve Başlangıç
 ****************************************************/
const firebaseConfig = {
  apiKey: "AIzaSyDThNGVa7YBhQIINuIOxUiLbTvu0cOZh4w",
  authDomain: "maping-c0315.firebaseapp.com",
  databaseURL: "https://maping-c0315-default-rtdb.firebaseio.com",
  projectId: "maping-c0315",
  storageBucket: "maping-c0315.firebasestorage.app",
  messagingSenderId: "1056086990632",
  appId: "1:1056086990632:web:1f83946cad5b68e2f73a1d",
  measurementId: "G-3N34BTYV8C"
};

// Firebase başlat
firebase.initializeApp(firebaseConfig);

// Kütüphane referansları
const auth = firebase.auth();
const db = firebase.firestore();

/***************************************************
 * 2) HTML Elementlerinin Seçilmesi
 ****************************************************/
const authModal = new bootstrap.Modal(document.getElementById('authModal'), {backdrop: 'static', keyboard: false});
const profileButton = document.getElementById('profileButton');
const profileModal = new bootstrap.Modal(document.getElementById('profileModal'), {});
const cityModal = new bootstrap.Modal(document.getElementById('cityModal'), {});

// Form butonları
const showRegisterFormBtn = document.getElementById('showRegisterForm');
const showLoginFormBtn = document.getElementById('showLoginForm');
const loginBtn = document.getElementById('loginBtn');
const registerBtn = document.getElementById('registerBtn');
const logoutBtn = document.getElementById('logoutBtn');
const buyCityBtn = document.getElementById('buyCityBtn');

// Form inputları
const loginEmailInput = document.getElementById('loginEmail');
const loginPasswordInput = document.getElementById('loginPassword');
const registerNameInput = document.getElementById('registerName');
const registerEmailInput = document.getElementById('registerEmail');
const registerPasswordInput = document.getElementById('registerPassword');

// Profil alanları
const profileNameSpan = document.getElementById('profileName');
const profileEmailSpan = document.getElementById('profileEmail');
const profileBalanceSpan = document.getElementById('profileBalance');
const profileCitiesSpan = document.getElementById('profileCities');

// Şehir detay modal alanları
const cityNameSpan = document.getElementById('cityName');
const cityPriceSpan = document.getElementById('cityPrice');
const cityOwnerSpan = document.getElementById('cityOwner');

/***************************************************
 * 3) Kayıt / Giriş Modalı Görünümü Arasında Geçiş
 ****************************************************/
document.getElementById('loginForm').style.display = 'block';
document.getElementById('registerForm').style.display = 'none';

showRegisterFormBtn.addEventListener('click', () => {
  document.getElementById('loginForm').style.display = 'none';
  document.getElementById('registerForm').style.display = 'block';
});

showLoginFormBtn.addEventListener('click', () => {
  document.getElementById('loginForm').style.display = 'block';
  document.getElementById('registerForm').style.display = 'none';
});

/***************************************************
 * 4) Seed (Örnek Şehir Verileri) İşlemi
 ****************************************************/
// Uygulama ilk çalıştığında Firestore içinde "cities" koleksiyonunda
// veri yoksa varsayılan şehirleri ekleyelim.
async function seedCitiesIfEmpty() {
  const citiesRef = db.collection('cities');
  const snapshot = await citiesRef.get();
  
  if (snapshot.empty) {
    // Örnek şehir verileri
    const defaultCities = [
      {
        name: 'İstanbul',
        price: 100,
        lat: 41.0082,
        long: 28.9784,
        ownerId: '',
        ownerName: ''
      },
      {
        name: 'Ankara',
        price: 80,
        lat: 39.9208,
        long: 32.8541,
        ownerId: '',
        ownerName: ''
      },
      {
        name: 'İzmir',
        price: 70,
        lat: 38.4237,
        long: 27.1428,
        ownerId: '',
        ownerName: ''
      }
    ];

    for (let city of defaultCities) {
      await citiesRef.doc(city.name).set(city);
    }
  }
}

/***************************************************
 * 5) Kullanıcı Giriş/Kayıt İşlemleri
 ****************************************************/
loginBtn.addEventListener('click', async () => {
  const email = loginEmailInput.value.trim();
  const password = loginPasswordInput.value.trim();
  
  if (!email || !password) {
    alert('Lütfen e-posta ve şifre girin!');
    return;
  }

  try {
    await auth.signInWithEmailAndPassword(email, password);
    // Giriş başarılı
    authModal.hide();
  } catch (error) {
    alert('Giriş hatası: ' + error.message);
  }
});

registerBtn.addEventListener('click', async () => {
  const name = registerNameInput.value.trim();
  const email = registerEmailInput.value.trim();
  const password = registerPasswordInput.value.trim();
  
  if (!name || !email || !password) {
    alert('Lütfen tüm alanları doldurun!');
    return;
  }
  
  if (password.length < 6) {
    alert('Şifre en az 6 karakter olmalı!');
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCredential.user;

    // Yeni kayıt olan kullanıcı için Firestore'da ek veriler
    await db.collection('users').doc(user.uid).set({
      uid: user.uid,
      name: name,
      email: email,
      balance: 1000,  // Varsayılan bakiye
      ownedCities: []
    });

    // Kayıt başarılı, giriş yapmış oluyoruz
    authModal.hide();
  } catch (error) {
    alert('Kayıt hatası: ' + error.message);
  }
});

logoutBtn.addEventListener('click', async () => {
  await auth.signOut();
});

/***************************************************
 * 6) Auth State (Oturum) Dinleme
 ****************************************************/
// Kullanıcı değiştiğinde tetiklenir
auth.onAuthStateChanged(async user => {
  if (user) {
    // Giriş yapıldı
    profileButton.style.display = 'inline-block';

    // Profil verilerini Firestore'dan çekelim
    const userDoc = await db.collection('users').doc(user.uid).get();
    const userData = userDoc.data();

    profileNameSpan.innerText = userData.name;
    profileEmailSpan.innerText = userData.email;
    profileBalanceSpan.innerText = userData.balance;
    profileCitiesSpan.innerText = userData.ownedCities.length > 0 
      ? userData.ownedCities.join(', ') 
      : 'Henüz şehir sahibi değilsin';

  } else {
    // Giriş yapılmadı
    profileButton.style.display = 'none';
    // Otomatik giriş/kayıt modalını aç
    authModal.show();
  }
});

/***************************************************
 * 7) amCharts 5 ile Harita Kurulumu
 ****************************************************/
let root = am5.Root.new("chartdiv");

// Tema
root.setThemes([
  am5themes_Animated.new(root)
]);

// Harita oluştur
let chart = root.container.children.push(
  am5map.MapChart.new(root, {
    panX: "none",
    panY: "none",
    wheelX: "none",
    wheelY: "none",
    projection: am5map.geoMercator() // Düz projeksiyon
  })
);

// Arka plan (dünya) polygon serisi
let polygonSeries = chart.series.push(
  am5map.MapPolygonSeries.new(root, {
    geoJSON: am5geodata_worldLow
  })
);

polygonSeries.mapPolygons.template.setAll({
  fill: am5.color(0xcccccc),
  stroke: am5.color(0xffffff)
});

// Şehir marker'ları için point serisi
let citySeries = chart.series.push(am5map.MapPointSeries.new(root, {}));

// Şehir verilerini Firestore'dan okuyup marker oluşturma fonksiyonu
async function loadCities() {
  const snapshot = await db.collection('cities').get();
  const cityData = [];
  
  snapshot.forEach(doc => {
    const data = doc.data();
    cityData.push({
      id: doc.id,
      latitude: data.lat,
      longitude: data.long,
      name: data.name,
      price: data.price,
      ownerId: data.ownerId,
      ownerName: data.ownerName
    });
  });

  // Mevcut markerları sıfırlamak istersek
  citySeries.data.setAll([]);

  // citySeries'e verileri ekle
  citySeries.bullets.push(function() {
    let circle = am5.Circle.new(root, {
      radius: 6,
      fill: am5.color(0xff0000),
      tooltipText: "{name}"
    });

    // Hover efekti
    circle.states.create("hover", {
      fill: am5.color(0x00ff00)
    });

    // Tıklama olayı
    circle.events.on("click", function(e) {
      let dataContext = e.target.dataItem.dataContext;
      openCityModal(dataContext);
    });

    return am5.Bullet.new(root, {
      sprite: circle
    });
  });

  citySeries.data.setAll(cityData);
}

// Şehir modalını açma
function openCityModal(cityData) {
  cityNameSpan.innerText = cityData.name;
  cityPriceSpan.innerText = cityData.price + " USDT";
  cityOwnerSpan.innerText = cityData.ownerId 
    ? (cityData.ownerName || "Bilinmiyor") 
    : "Henüz satın alınmamış";
  
  // Buy butonuna basıldığında hangi şehri satın alacağımızı bilmek için
  buyCityBtn.setAttribute("data-city-id", cityData.id);

  // Eğer sahibi varsa ve sahibi bizsek "Satın Al" butonunu pasif yapabiliriz
  const currentUser = auth.currentUser;
  if (cityData.ownerId === currentUser?.uid) {
    buyCityBtn.disabled = true;
    buyCityBtn.innerText = "Zaten Sahipsiniz";
  } else {
    buyCityBtn.disabled = false;
    buyCityBtn.innerText = "Satın Al";
  }

  cityModal.show();
}

// Şehir satın alma işlemi
buyCityBtn.addEventListener('click', async () => {
  const cityId = buyCityBtn.getAttribute("data-city-id");
  const currentUser = auth.currentUser;
  if (!cityId || !currentUser) return;

  try {
    // Önce şehir verisini ve kullanıcı verisini çekelim
    const cityDocRef = db.collection('cities').doc(cityId);
    const userDocRef = db.collection('users').doc(currentUser.uid);

    const [cityDoc, userDoc] = await Promise.all([
      cityDocRef.get(),
      userDocRef.get()
    ]);

    if (!cityDoc.exists) {
      alert("Şehir kaydı bulunamadı!");
      return;
    }
    if (!userDoc.exists) {
      alert("Kullanıcı kaydı bulunamadı!");
      return;
    }

    const cityData = cityDoc.data();
    const userData = userDoc.data();

    // Şehir zaten sahibi varsa satın alamayız (başkası da olabilir)
    if (cityData.ownerId && cityData.ownerId !== currentUser.uid) {
      alert("Şehir zaten başka bir kullanıcıya ait!");
      return;
    }

    // Bakiye kontrolü
    if (userData.balance < cityData.price) {
      alert("Yetersiz bakiye!");
      return;
    }

    // Satın alma güncellemeleri (Transaction ya da batch tercih edilebilir)
    const newBalance = userData.balance - cityData.price;
    const newOwnedCities = userData.ownedCities || [];
    if (!newOwnedCities.includes(cityData.name)) {
      newOwnedCities.push(cityData.name);
    }

    // Firestore güncellemesi
    await userDocRef.update({
      balance: newBalance,
      ownedCities: newOwnedCities
    });

    await cityDocRef.update({
      ownerId: currentUser.uid,
      ownerName: userData.name
    });

    alert(cityData.name + " şehri satın alındı!");

    // Modal kapat, haritayı ve profil bilgilerini yenile
    cityModal.hide();
    loadCities(); // Marker üzerindeki ownerId bilgisi yenilensin
    // Profil modal açık ise, oradaki verileri de yenilemek için tekrar alalım
    const updatedUserDoc = await userDocRef.get();
    const updatedUserData = updatedUserDoc.data();
    profileBalanceSpan.innerText = updatedUserData.balance;
    profileCitiesSpan.innerText = updatedUserData.ownedCities.join(', ');
  } catch (error) {
    alert("Satın alma hatası: " + error.message);
  }
});

/***************************************************
 * 8) Sayfa Yüklendiğinde Yapılacaklar
 ****************************************************/
window.addEventListener('load', async () => {
  // Önce seed işlemini yap (şehir yoksa ekle)
  await seedCitiesIfEmpty();
  // Sonra şehirleri yükle
  await loadCities();
});
</script>
</body>
</html>
