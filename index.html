<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MEXC Futures vs Spot (Index) Fark Takibi + Bot</title>
<style>
  :root{
    --bg:#0f1115; --fg:#e9eef6; --muted:#9aa3ad; --card:#151922; --accent:#3b82f6;
    --green:#10b981; --orange:#f59e0b; --red:#ef4444; --gap:10px; --rowh:48px; --scale:1.0;
    --good:#16a34a; --bad:#dc2626; --chip:#1f2532;
  }
  [data-theme="white"]{
    --bg:#ffffff; --fg:#0b1220; --muted:#5a6675; --card:#f4f6f9; --accent:#2563eb;
    --chip:#e8edf5;
  }
  [data-theme="charcoal"]{
    --bg:#0b0c0f; --fg:#e6edf7; --muted:#94a3b8; --card:#141820; --accent:#22c55e;
    --chip:#1a2030;
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--fg);font:500 16px/1.35 ui-sans-serif,system-ui,Segoe UI,Roboto,Arial}
  .wrap{max-width:1200px;margin:0 auto;padding:16px; transform:scale(var(--scale)); transform-origin: top center;}
  h1{font-size:20px;margin:0 0 8px 0}
  .bar{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
  .card{background:var(--card);border-radius:16px;padding:12px}
  .pill{background:var(--chip);border-radius:999px;padding:6px 10px;display:inline-flex;gap:8px;align-items:center}
  .btn{cursor:pointer;border:0;border-radius:10px;padding:10px 12px;background:var(--accent);color:white;font-weight:700}
  .btn.sec{background:transparent;border:1px solid #2a3344;color:var(--fg)}
  .btn.danger{background:var(--red)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .top{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .knot{display:flex;gap:8px;align-items:center}
  label{font-size:13px;color:var(--muted)}
  input[type=text],input[type=number],input[type=password],select{
    background:transparent;border:1px solid #2a3344;color:var(--fg);padding:8px 10px;border-radius:10px;outline:none;min-width:0
  }
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{background:var(--chip);padding:6px 10px;border-radius:999px;display:inline-flex;gap:8px;align-items:center}
  .chip b{letter-spacing:.3px}
  .chip button{all:unset;cursor:pointer;color:var(--muted)}
  .switch{display:inline-flex;align-items:center;gap:8px;cursor:pointer}
  .switch input{width:18px;height:18px}
  .table{margin-top:12px;border-radius:14px;overflow:hidden}
  table{width:100%;border-collapse:separate;border-spacing:0}
  thead th{background:var(--card);text-align:left;padding:12px 10px;color:var(--muted);position:sticky;top:0}
  tbody td{background:transparent;padding:10px}
  tbody tr{height:var(--rowh);border-bottom:1px solid #1e2430}
  .num{font-variant-numeric:tabular-nums}
  .tight{display:grid;grid-template-columns: 180px 1fr 1fr 120px; column-gap: var(--gap); align-items:center}
  .badge{font-weight:800}
  .al{background:rgba(16,185,129,.14);color:#c6fff0;border-radius:8px;padding:6px 8px}
  .sat{background:rgba(245,158,11,.15);color:#ffe7c3;border-radius:8px;padding:6px 8px}
  [data-theme="white"] .al{background:#e9fff8;color:#065f46}
  [data-theme="white"] .sat{background:#fff5e6;color:#7c2d12}
  .topcard{font-size:18px;font-weight:800}
  .good{color:var(--good)} .bad{color:var(--bad)}
  .rowname{font-weight:800;letter-spacing:.3px}
  .muted{color:var(--muted)}
  details{border:1px solid #2a3344;border-radius:12px;padding:10px}
  summary{cursor:pointer;font-weight:800}
  .sect{display:grid;grid-template-columns:1fr 1fr;gap:12px}
  .foot{margin-top:16px;color:var(--muted);font-size:12px}
</style>
</head>
<body>
<div class="wrap" id="app" data-theme="dark">
  <h1>MEXC SPOT (Index) ‚ÜîÔ∏é FUTURES Fark Takibi + Bot</h1>
  <div class="bar">
    <div class="knot">
      <label for="theme">Tema</label>
      <select id="theme" aria-label="Arka Plan Temasƒ±">
        <option value="dark">Koyu</option>
        <option value="white">Beyaz</option>
        <option value="charcoal">K√∂m√ºr</option>
      </select>
    </div>
    <div class="knot">
      <label for="interval">Hƒ±z</label>
      <select id="interval" aria-label="G√ºncelleme Sƒ±klƒ±ƒüƒ± (saniye)">
        <option value="100">0.1s</option>
        <option value="250">0.25s</option>
        <option value="500">0.5s</option>
        <option value="1000" selected>1s</option>
        <option value="2000">2s</option>
        <option value="4000">4s</option>
      </select>
    </div>
    <div class="knot">
      <label for="th">Fark E≈üiƒüi (%)</label>
      <input id="th" type="number" min="0" step="0.01" value="0.20" aria-label="Fark e≈üiƒüi y√ºzde"/>
    </div>
    <label class="switch">
      <input id="showTop" type="checkbox" checked/> En Y√ºksek Fark Kartƒ±
    </label>
    <details id="uiPanel">
      <summary>üéõÔ∏è Ki≈üiselle≈ütir</summary>
      <div class="sect" style="margin-top:8px">
        <div class="knot">
          <label for="scale">Tablo √ñl√ßeƒüi (0.8‚Äì1.2)</label>
          <input id="scale" type="number" step="0.05" min="0.8" max="1.2" value="1.0"/>
        </div>
        <div class="knot">
          <label for="rowh">Satƒ±r Y√ºksekliƒüi (px)</label>
          <input id="rowh" type="number" step="2" min="36" max="72" value="48"/>
        </div>
        <div class="knot">
          <label for="gap">S√ºtun Aralƒ±ƒüƒ± (px)</label>
          <input id="gap" type="number" step="2" min="4" max="20" value="10"/>
        </div>
      </div>
    </details>
  </div>

  <div class="grid">
    <div class="card">
      <div class="top">
        <div>
          <label for="symbol">Coin Ekle (√∂rn: BTCUSDT ya da BTC_USDT)</label><br/>
          <input id="symbol" type="text" placeholder="BTCUSDT" aria-label="Coin Sembol√º"/>
          <button class="btn" id="addBtn">Ekle</button>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">Takip Listesi</div>
          <div class="chips" id="chips"></div>
        </div>
      </div>
      <div id="topCard" class="card" style="margin-top:12px;display:none">
        <div class="topcard" id="topText">‚Äî</div>
      </div>
      <div class="table">
        <table>
          <thead>
            <tr>
              <th>Coin</th>
              <th>AL (Ucuz)</th>
              <th>SAT (Pahalƒ±)</th>
              <th>Fark %</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>

    <div class="card">
      <details open>
        <summary>ü§ñ Bot</summary>
        <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:10px">
          <label class="switch"><input id="botEnable" type="checkbox"/> Bot Aktif</label>
          <label class="switch"><input id="dryRun" type="checkbox" checked/> Dry-Run (emir g√∂nderme)</label>

          <div class="knot">
            <label for="botTh">Bot E≈üiƒüi (%)</label>
            <input id="botTh" type="number" min="0" step="0.01" value="0.50"/>
          </div>
          <div class="knot">
            <label for="leverage">Kaldƒ±ra√ß</label>
            <input id="leverage" type="number" min="1" max="125" step="1" value="10"/>
          </div>
          <div class="knot">
            <label for="amount">Tutar (USDT)</label>
            <input id="amount" type="number" min="5" step="1" value="50"/>
          </div>
          <div class="knot">
            <label for="cooldown">Cooldown (sn)</label>
            <input id="cooldown" type="number" min="0" step="1" value="60"/>
          </div>
          <div class="knot">
            <label for="openType">Marjin</label>
            <select id="openType">
              <option value="1" selected>Isolated</option>
              <option value="2">Cross</option>
            </select>
          </div>
          <div class="knot">
            <label for="proxy">Proxy URL (server.js)</label>
            <input id="proxy" type="text" placeholder="https://sizin-proxy.com"/>
          </div>

          <div style="grid-column:1/-1;border-top:1px solid #2a3344;padding-top:10px" class="muted">
            API anahtarƒ±nƒ±zƒ± **proxy sunucunuza** koymanƒ±z √∂nerilir. ƒ∞sterseniz bu sayfadan da g√∂nderebilirsiniz (riskli).
          </div>
          <div class="knot">
            <label for="apiKey">MEXC API Key</label>
            <input id="apiKey" type="text" placeholder="..." />
          </div>
          <div class="knot">
            <label for="apiSecret">MEXC API Secret</label>
            <input id="apiSecret" type="password" placeholder="..." />
          </div>
        </div>
      </details>
      <div class="foot">
        Fiyatlar **WebSocket**: <code>wss://contract.mexc.com/edge</code> ‚Äì <em>sub.ticker</em> (futures), <em>sub.index.price</em> (spot endeks). Emir u√ß noktalarƒ± i√ßin k√º√ß√ºk bir proxy gerekir (CORS & g√ºvenlik). Belgeler: WS kanallarƒ±, emir & kaldƒ±ra√ß API‚Äôleri. :contentReference[oaicite:4]{index=4}
      </div>
    </div>
  </div>
</div>

<script>
(()=>{

// ---------- Kalƒ±cƒ± ayarlar ----------
const LS = {
  coins: 'mexc_coins',
  interval: 'mexc_interval',
  th: 'mexc_thresh',
  theme: 'mexc_theme',
  scale:'mexc_scale', rowh:'mexc_rowh', gap:'mexc_gap',
  showTop:'mexc_showTop',
  bot:'mexc_bot'
};

const state = {
  ws: null,
  connected:false,
  prices: new Map(), // symbol -> { fut:{last,bid1,ask1}, spot:{index} }
  coins: JSON.parse(localStorage.getItem(LS.coins) || '[]'),
  tickTimer:null,
  lastTopActionAt:0
};

const el = id=>document.getElementById(id);
const app = document.getElementById('app');
const tbody = el('tbody');
const chips = el('chips');
const topCard = el('topCard');
const topText = el('topText');

function save(key, val){ localStorage.setItem(key, typeof val==='string'? val : JSON.stringify(val)); }

// ---------- UI init ----------
el('theme').value = localStorage.getItem(LS.theme)||'dark';
applyTheme(el('theme').value);
el('theme').addEventListener('change', e=>{ applyTheme(e.target.value); save(LS.theme,e.target.value); });

el('interval').value = localStorage.getItem(LS.interval)||'1000';
el('th').value = localStorage.getItem(LS.th)||'0.20';
el('scale').value = localStorage.getItem(LS.scale)||'1.0';
el('rowh').value = localStorage.getItem(LS.rowh)||'48';
el('gap').value = localStorage.getItem(LS.gap)||'10';
el('showTop').checked = JSON.parse(localStorage.getItem(LS.showTop) ?? 'true');

applyDims();
el('scale').addEventListener('input', ()=>{ save(LS.scale,el('scale').value); applyDims(); });
el('rowh').addEventListener('input', ()=>{ save(LS.rowh,el('rowh').value); applyDims(); });
el('gap').addEventListener('input', ()=>{ save(LS.gap,el('gap').value); applyDims(); });
el('showTop').addEventListener('change', ()=>{ save(LS.showTop, el('showTop').checked); });

el('interval').addEventListener('change', ()=>save(LS.interval, el('interval').value));
el('th').addEventListener('change', ()=>save(LS.th, el('th').value));

function applyTheme(t){ app.setAttribute('data-theme', t); }
function applyDims(){
  app.style.setProperty('--scale', el('scale').value);
  app.style.setProperty('--rowh', el('rowh').value+'px');
  app.style.setProperty('--gap', el('gap').value+'px');
}

// Bot ayarlarƒ±
const defaultBot = {
  enabled:false, dry:true, th:0.50, lev:10, amt:50, cooldown:60, openType:1, proxy:'', key:'', sec:''
};
const bot = Object.assign({}, defaultBot, JSON.parse(localStorage.getItem(LS.bot) || '{}'));
el('botEnable').checked = !!bot.enabled;
el('dryRun').checked = bot.dry ?? true;
el('botTh').value = (bot.th ?? 0.50);
el('leverage').value = bot.lev ?? 10;
el('amount').value = bot.amt ?? 50;
el('cooldown').value = bot.cooldown ?? 60;
el('openType').value = bot.openType ?? 1;
el('proxy').value = bot.proxy || '';
el('apiKey').value = bot.key || '';
el('apiSecret').value = bot.sec || '';

function saveBot(){
  const b = {
    enabled: el('botEnable').checked,
    dry: el('dryRun').checked,
    th: parseFloat(el('botTh').value||'0') ,
    lev: parseInt(el('leverage').value||'10'),
    amt: parseFloat(el('amount').value||'50'),
    cooldown: parseInt(el('cooldown').value||'60'),
    openType: parseInt(el('openType').value||'1'),
    proxy: el('proxy').value.trim(),
    key: el('apiKey').value.trim(),
    sec: el('apiSecret').value.trim()
  };
  save(LS.bot, b);
  return b;
}
['botEnable','dryRun','botTh','leverage','amount','cooldown','openType','proxy','apiKey','apiSecret']
.forEach(id=> el(id).addEventListener('change', saveBot));

// ---------- Coin chips ----------
function normSym(s){
  s = (s||'').toUpperCase().trim();
  if(!s) return '';
  if(!s.includes('_')) s = s.replace('USDT','_USDT');
  return s;
}
function renderChips(){
  chips.innerHTML = '';
  state.coins.forEach(sym=>{
    const c = document.createElement('div'); c.className='chip';
    const b = document.createElement('b'); b.textContent = sym.replace('_','');
    const x = document.createElement('button'); x.innerHTML='‚úï';
    x.addEventListener('click', ()=> removeCoin(sym));
    c.appendChild(b); c.appendChild(x); chips.appendChild(c);
  });
}
function addCoin(){
  const s = normSym(el('symbol').value);
  if(!s.endsWith('_USDT')) { alert('Sadece *_USDT s√∂zle≈ümeleri.'); return; }
  if(!state.coins.includes(s)){
    state.coins.push(s);
    save(LS.coins, state.coins);
    renderChips();
    wsSub(s, true);
  }
  el('symbol').value='';
}
function removeCoin(s){
  state.coins = state.coins.filter(x=>x!==s);
  save(LS.coins, state.coins);
  state.prices.delete(s);
  renderChips();
  wsSub(s, false);
  draw();
}
el('addBtn').addEventListener('click', addCoin);
el('symbol').addEventListener('keydown', e=>{ if(e.key==='Enter') addCoin(); });
renderChips();

// ---------- WebSocket (MEXC Futures) ----------
function wsConnect(){
  if(state.ws) try{state.ws.close()}catch(e){}
  const ws = new WebSocket('wss://contract.mexc.com/edge');
  state.ws = ws; state.connected=false;

  ws.onopen = ()=>{
    state.connected=true;
    ping();
    // Var olanlarƒ± abone et
    state.coins.forEach(sym=> wsSub(sym,true));
  };
  ws.onmessage = (ev)=>{
    // bazƒ± mesajlar gzip olabiliyor ‚Äî edge endpoint genelde d√ºz JSON
    try{
      const msg = JSON.parse(ev.data);
      if(msg.channel==='pong') return;
      if(msg.channel==='push.ticker' && msg.data){
        const d = msg.data;
        const sym = d.symbol;
        const m = state.prices.get(sym) || {fut:{}, spot:{}};
        m.fut = { last:d.lastPrice, bid1:d.bid1, ask1:d.ask1 };
        state.prices.set(sym, m);
      }
      if(msg.channel==='push.index.price' && msg.data){
        const d = msg.data;
        const sym = d.symbol;
        const m = state.prices.get(sym) || {fut:{}, spot:{}};
        m.spot = { index:d.price };
        state.prices.set(sym, m);
      }
    }catch(_){}
  };
  ws.onclose = ()=>{ state.connected=false; setTimeout(wsConnect, 1000); };
}
function wsSub(sym, on){
  if(!state.ws || state.ws.readyState!==1) return;
  const a = on ? 'sub':'unsub';
  state.ws.send(JSON.stringify({ method: a+'.ticker', param:{symbol:sym}}));
  state.ws.send(JSON.stringify({ method: a+'.index.price', param:{symbol:sym}}));
}
function ping(){
  if(!state.ws || state.ws.readyState!==1) return;
  state.ws.send(JSON.stringify({method:'ping'}));
  setTimeout(ping, 15000);
}
wsConnect();

// ---------- Hesaplama & √áizim ----------
function computeRows(){
  const th = parseFloat(el('th').value||'0');
  const rows = [];
  for(const [sym, m] of state.prices.entries()){
    const fut = m.fut?.last ?? m.fut?.bid1;
    const spot = m.spot?.index;
    if(!fut || !spot) continue;

    // Fark, y√∂n ve AL/SAT:
    // Futures < Spot => FUTURES LONG fƒ±rsatƒ± (ucuz futures)
    // Futures > Spot => FUTURES SHORT fƒ±rsatƒ± (pahalƒ± futures)
    const diff = fut < spot ? (spot - fut)/spot : (fut - spot)/spot;
    const pct = diff*100;

    if(pct*1.0000001 < th) continue;

    const isLong = fut < spot;
    const lowPrice = Math.min(fut, spot);
    const highPrice = Math.max(fut, spot);

    rows.push({
      sym,
      low: lowPrice,   // AL
      high: highPrice, // SAT
      pct,
      lowIsSpot: spot<=fut, // ye≈üil
      highIsSpot: spot>=fut,
      // top card info:
      action: isLong ? 'FUTURES LONG' : 'FUTURES SHORT',
      futPrice: fut,
      spotPrice: spot
    });
  }
  rows.sort((a,b)=> b.pct - a.pct);
  return rows;
}

function draw(){
  const rows = computeRows();
  // Top card
  const showTop = el('showTop').checked;
  topCard.style.display = (showTop && rows.length>0) ? 'block':'none';
  if(showTop && rows[0]){
    const r = rows[0];
    const price = r.futPrice?.toFixed(4);
    const pct = r.pct.toFixed(2);
    const cls = r.action.includes('LONG') ? 'good' : 'bad';
    topText.innerHTML = `${r.sym.replace('_','')} <span class="${cls}">${r.action}</span> ${price} USDT <span class="muted">%</span>${pct}`;
  }

  // Table
  tbody.innerHTML='';
  for(const r of rows){
    const tr = document.createElement('tr');
    const td = (html)=>{ const c=document.createElement('td'); c.innerHTML=html; return c; };

    const name = `<div class="rowname">${r.sym.replace('_','')}</div>`;
    const al = `<div class="${r.lowIsSpot?'al':'sat'} num"><b>AL</b> ${r.low.toFixed(4)}</div>`;
    const sat = `<div class="${r.highIsSpot?'al':'sat'} num"><b>SAT</b> ${r.high.toFixed(4)}</div>`;
    const pct = `<div class="num badge">${r.pct.toFixed(3)}</div>`;

    const wrap = (left, a, b, c) => `<div class="tight"><div>${left}</div><div>${a}</div><div>${b}</div><div>${c}</div></div>`;

    tr.appendChild(td(wrap(name, al, sat, pct)));
    tbody.appendChild(tr);
  }
}

function tick(){
  draw();
  maybeBot();
}

function startLoop(){
  if(state.tickTimer) clearInterval(state.tickTimer);
  const ms = parseInt(el('interval').value||'1000');
  state.tickTimer = setInterval(tick, ms);
}
startLoop();
el('interval').addEventListener('change', startLoop);

// ---------- BOT ----------
async function maybeBot(){
  const b = saveBot();
  if(!b.enabled) return;

  const now = Date.now();
  if(now - state.lastTopActionAt < (b.cooldown*1000)) return;

  const rows = computeRows();
  if(rows.length===0) return;

  const r = rows[0];
  if(r.pct < b.th) return;

  const sym = r.sym;
  const side = r.action.includes('LONG') ? 1 : 3; // 1 open long, 3 open short
  const last = r.futPrice;

  console.log('[BOT]', sym, r.action, r.pct.toFixed(3)+'%');

  if(b.dry){ state.lastTopActionAt = now; console.log('Dry-Run: emir g√∂nderilmedi'); return; }

  if(!b.proxy){ console.warn('Proxy URL tanƒ±mlƒ± deƒüil.'); return; }

  try{
    // 1) s√∂zle≈üme detaylarƒ± (contractSize/minVol)
    const det = await fetch(`${b.proxy}/mexc/contract/detail?symbol=${encodeURIComponent(sym)}`).then(r=>r.json());
    if(!det.success){ console.error(det); return; }
    const info = det.data;
    const contractSize = info.contractSize || 0.0001;
    const volUnit = info.volUnit || 1;
    const minVol = info.minVol || 1;

    // 2) USDT tutarƒ± ‚Üí s√∂zle≈üme adedi (vol)
    const coinQty = b.amt / last;
    let vol = Math.floor( (coinQty / contractSize) / volUnit ) * volUnit;
    if(vol < minVol) vol = minVol;

    // 3) Kaldƒ±ra√ß ayarƒ± (pozisyon yoksa symbol+openType ile √ßaƒüƒ±rƒ±n)
    await fetch(`${b.proxy}/mexc/position/change_leverage`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        apiKey:b.key, apiSecret:b.sec,
        body:{ openType:b.openType, leverage:b.lev, symbol:sym, positionType: side===1?1:2 }
      })
    });

    // 4) Pazar emri (type=5) ‚Äì price zorunluysa last ge√ßiyoruz
    const res = await fetch(`${b.proxy}/mexc/order/submit`, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        apiKey:b.key, apiSecret:b.sec,
        body:{
          symbol:sym, price:last, vol, leverage:b.lev, side, type:5, openType:b.openType
        }
      })
    }).then(r=>r.json());

    if(res.success){
      state.lastTopActionAt = now;
      console.log('EMƒ∞R G√ñNDERƒ∞LDƒ∞', res);
      alert(`Emir OK: ${sym} ${side===1?'LONG':'SHORT'} vol=${vol}`);
    }else{
      console.error('Emir Hatasƒ±', res);
    }

  }catch(err){
    console.error('Bot hata', err);
  }
}

})();</script>
</body>
</html>
