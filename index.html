<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CitySell Harita Oyunu</title>

  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- amCharts 5 -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>

  <!-- Firebase JS SDK (7.20.0 ve sonrası) -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>

  <style>
    /* Tam ekran harita alanı */
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #chartdiv {
      width: 100%;
      height: 100vh; /* Tam ekran yükseklik */
    }

    /* Bazı temel modal düzenlemeleri */
    .modal-header {
      background-color: #0d6efd;
      color: #fff;
    }
    .modal-footer button {
      min-width: 90px;
    }
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">CitySell</a>
      <div class="d-flex">
        <!-- Profil butonu: Başlangıçta gizli, giriş yapınca gösterilecek -->
        <button
          id="btnProfile"
          class="btn btn-light text-primary me-2"
          style="display: none;"
          data-bs-toggle="modal"
          data-bs-target="#profileModal"
        >
          Profil
        </button>
        <!-- Çıkış butonu: Başlangıçta gizli, giriş yapınca gösterilecek -->
        <button
          id="btnLogout"
          class="btn btn-danger"
          style="display: none;"
        >
          Çıkış
        </button>
      </div>
    </div>
  </nav>

  <!-- Harita Container -->
  <div id="chartdiv"></div>

  <!-- Kayıt/Giriş Modal -->
  <div
    class="modal fade"
    id="authModal"
    tabindex="-1"
    aria-labelledby="authModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="authModalLabel">Kayıt Ol veya Giriş Yap</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Kapat"
          ></button>
        </div>
        <div class="modal-body">
          <!-- Nav tabs -->
          <ul class="nav nav-tabs" id="authTab" role="tablist">
            <li class="nav-item" role="presentation">
              <button
                class="nav-link active"
                id="register-tab"
                data-bs-toggle="tab"
                data-bs-target="#register"
                type="button"
                role="tab"
                aria-controls="register"
                aria-selected="true"
              >
                Kayıt Ol
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button
                class="nav-link"
                id="login-tab"
                data-bs-toggle="tab"
                data-bs-target="#login"
                type="button"
                role="tab"
                aria-controls="login"
                aria-selected="false"
              >
                Giriş Yap
              </button>
            </li>
          </ul>
          <!-- Tab panes -->
          <div class="tab-content pt-3">
            <!-- Kayıt Ol -->
            <div
              class="tab-pane fade show active"
              id="register"
              role="tabpanel"
              aria-labelledby="register-tab"
            >
              <form id="registerForm">
                <div class="mb-3">
                  <label for="registerUsername" class="form-label">Kullanıcı Adı</label>
                  <input
                    type="text"
                    class="form-control"
                    id="registerUsername"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="registerEmail" class="form-label">E-posta</label>
                  <input
                    type="email"
                    class="form-control"
                    id="registerEmail"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="registerPassword" class="form-label">Şifre (min 6 karakter)</label>
                  <input
                    type="password"
                    class="form-control"
                    id="registerPassword"
                    minlength="6"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-primary w-100">Kayıt Ol</button>
              </form>
            </div>
            <!-- Giriş Yap -->
            <div
              class="tab-pane fade"
              id="login"
              role="tabpanel"
              aria-labelledby="login-tab"
            >
              <form id="loginForm">
                <div class="mb-3">
                  <label for="loginEmail" class="form-label">E-posta</label>
                  <input
                    type="email"
                    class="form-control"
                    id="loginEmail"
                    required
                  />
                </div>
                <div class="mb-3">
                  <label for="loginPassword" class="form-label">Şifre</label>
                  <input
                    type="password"
                    class="form-control"
                    id="loginPassword"
                    required
                  />
                </div>
                <button type="submit" class="btn btn-success w-100">Giriş Yap</button>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profil Modal -->
  <div
    class="modal fade"
    id="profileModal"
    tabindex="-1"
    aria-labelledby="profileModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="profileModalLabel">Profil Bilgileri</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Kapat"
          ></button>
        </div>
        <div class="modal-body">
          <p><strong>Kullanıcı Adı:</strong> <span id="profileUsername"></span></p>
          <p><strong>Bakiye (USDT):</strong> <span id="profileBalance"></span></p>
          <p><strong>Sahip Olduğunuz Şehirler:</strong></p>
          <ul id="profileCities"></ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Şehir Detay Modal -->
  <div
    class="modal fade"
    id="cityModal"
    tabindex="-1"
    aria-labelledby="cityModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog modal-dialog-centered modal-md">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cityModalLabel">Şehir Detayı</h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Kapat"
          ></button>
        </div>
        <div class="modal-body">
          <p><strong>Şehir Adı:</strong> <span id="cityName"></span></p>
          <p><strong>Fiyat (USDT):</strong> <span id="cityPrice"></span></p>
          <p><strong>Sahibi:</strong> <span id="cityOwner"></span></p>
        </div>
        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Kapat
          </button>
          <button
            type="button"
            class="btn btn-primary"
            id="btnBuyCity"
          >
            Satın Al
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap 5 JS (Popper dahil) -->
  <script
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
  ></script>

  <script>
    /********************/
    /** Firebase Config */
    /********************/
    // Lütfen kendi firebaseConfig değerlerinizi giriniz.
    const firebaseConfig = {
        apiKey: "AIzaSyB2LQX2rSPYmV9fCn9S02R1zz9welQ9Skc",
  authDomain: "citysell-45e32.firebaseapp.com",
  projectId: "citysell-45e32",
  storageBucket: "citysell-45e32.firebasestorage.app",
  messagingSenderId: "325438858648",
  appId: "1:325438858648:web:0c13beb02cd1a2b08fb7ed",
  measurementId: "G-2HR99X6LXY
    };

    // Firebase başlatma
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Test aşamasında Firestore güvenlik kurallarınızı
    // "allow read, write: if true;" olarak ayarlamayı unutmayın.

    /**************************************************/
    /** DOM Elementleri ve Global Değişkenlerin Tanımı */
    /**************************************************/
    const authModal = new bootstrap.Modal(document.getElementById("authModal"), {
      backdrop: "static",
      keyboard: false,
    });
    const profileModal = new bootstrap.Modal(document.getElementById("profileModal"));
    const cityModal = new bootstrap.Modal(document.getElementById("cityModal"));

    const btnProfile = document.getElementById("btnProfile");
    const btnLogout = document.getElementById("btnLogout");

    const profileUsernameEl = document.getElementById("profileUsername");
    const profileBalanceEl = document.getElementById("profileBalance");
    const profileCitiesEl = document.getElementById("profileCities");

    const cityNameEl = document.getElementById("cityName");
    const cityPriceEl = document.getElementById("cityPrice");
    const cityOwnerEl = document.getElementById("cityOwner");
    const btnBuyCity = document.getElementById("btnBuyCity");

    let currentUser = null;         // Oturum açmış kullanıcı
    let selectedCityId = null;      // Modal'da görüntülenen şehir ID'si
    let selectedCityPrice = 0;      // Modal'da görüntülenen şehrin fiyatı

    /**************************************************/
    /** Kayıt / Giriş Formu Olay Dinleyicileri        */
    /**************************************************/
    const registerForm = document.getElementById("registerForm");
    registerForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("registerUsername").value.trim();
      const email = document.getElementById("registerEmail").value.trim();
      const password = document.getElementById("registerPassword").value;

      try {
        // Firebase Auth ile kullanıcı oluşturma
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;

        // Firestore'a kullanıcı ekleme
        await db.collection("users").doc(user.uid).set({
          username: username,
          email: email,
          balance: 1000,     // Yeni kullanıcıya örnek olarak 1000 USDT verilebilir
          cities: [],        // Başlangıçta şehir yok
        });

        // Kayıt başarılı -> modal'ı kapat
        authModal.hide();
      } catch (error) {
        alert("Kayıt olurken hata: " + error.message);
      }
    });

    const loginForm = document.getElementById("loginForm");
    loginForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const email = document.getElementById("loginEmail").value.trim();
      const password = document.getElementById("loginPassword").value;

      try {
        // Firebase Auth ile giriş
        await auth.signInWithEmailAndPassword(email, password);
        authModal.hide();
      } catch (error) {
        alert("Giriş yaparken hata: " + error.message);
      }
    });

    /**************************************************/
    /** Çıkış Butonu Olay Dinleyicisi                 */
    /**************************************************/
    btnLogout.addEventListener("click", async () => {
      await auth.signOut();
    });

    /**************************************************/
    /** Auth State Değişikliği (onAuthStateChanged)   */
    /**************************************************/
    auth.onAuthStateChanged(async (user) => {
      if (user) {
        // Kullanıcı giriş yaptı
        currentUser = user;
        btnProfile.style.display = "inline-block";
        btnLogout.style.display = "inline-block";

        // Şehir seed işlemi
        await seedCitiesIfNeeded();

        // Haritayı yükle
        renderMap();

      } else {
        // Kullanıcı çıkış yaptı veya henüz giriş yapmadı
        currentUser = null;
        btnProfile.style.display = "none";
        btnLogout.style.display = "none";

        // Giriş/Kayıt modal'ını otomatik aç
        authModal.show();
      }
    });

    /**************************************************/
    /** Profil Modal Açıldığında Bilgi Güncelleme     */
    /**************************************************/
    document.getElementById("profileModal").addEventListener("show.bs.modal", async () => {
      if (!currentUser) return;

      const userDoc = await db.collection("users").doc(currentUser.uid).get();
      if (userDoc.exists) {
        const userData = userDoc.data();
        profileUsernameEl.textContent = userData.username || "";
        profileBalanceEl.textContent = userData.balance || 0;

        // Şehir listesini doldur
        profileCitiesEl.innerHTML = "";
        if (Array.isArray(userData.cities) && userData.cities.length > 0) {
          userData.cities.forEach((cityName) => {
            const li = document.createElement("li");
            li.textContent = cityName;
            profileCitiesEl.appendChild(li);
          });
        } else {
          const li = document.createElement("li");
          li.textContent = "Henüz şehriniz yok.";
          profileCitiesEl.appendChild(li);
        }
      }
    });

    /**************************************************/
    /** Şehir Seed İşlemi (Firestore'da yoksa ekle)   */
    /**************************************************/
    async function seedCitiesIfNeeded() {
      const citiesRef = db.collection("cities");
      const snapshot = await citiesRef.get();
      if (snapshot.empty) {
        // Örnek şehirler seed ediliyor
        const seedData = [
          {
            name: "İstanbul",
            price: 200,
            latitude: 41.0082,
            longitude: 28.9784,
            ownerId: null,
          },
          {
            name: "Ankara",
            price: 150,
            latitude: 39.9208,
            longitude: 32.8541,
            ownerId: null,
          },
          {
            name: "İzmir",
            price: 100,
            latitude: 38.4237,
            longitude: 27.1428,
            ownerId: null,
          },
        ];

        for (let city of seedData) {
          await citiesRef.add(city);
        }
      }
    }

    /**************************************************/
    /** amCharts 5 ile Harita Oluşturma               */
    /**************************************************/
    let chart; // Global olarak tanımlayalım, tekrar tekrar oluşturmasın

    async function renderMap() {
      // Eğer chart zaten varsa, temizleyelim
      if (chart) {
        chart.dispose();
      }

      // amCharts root oluşturalım
      let root = am5.Root.new("chartdiv");

      // Tema
      root.setThemes([am5themes_Animated.new(root)]);

      // Map Chart
      chart = root.container.children.push(
        am5map.MapChart.new(root, {
          panX: "none",
          panY: "none",
          wheelY: "none",
          projection: am5map.geoMercator(),
        })
      );

      // Dünya haritası polygon serisi
      let polygonSeries = chart.series.push(
        am5map.MapPolygonSeries.new(root, {
          geoJSON: am5geodata_worldLow
        })
      );

      polygonSeries.mapPolygons.template.setAll({
        tooltipText: "{name}",
        interactive: true,
        fill: am5.color(0xd0d0d0),
      });

      polygonSeries.mapPolygons.template.states.create("hover", {
        fill: am5.color(0x677935),
      });

      // Şehir noktaları için bir seri oluşturalım
      let pointSeries = chart.series.push(
        am5map.MapPointSeries.new(root, {
          latitudeField: "latitude",
          longitudeField: "longitude"
        })
      );

      // Şehir verilerini Firestore'dan çekelim
      const citiesSnapshot = await db.collection("cities").get();
      let cityData = [];
      citiesSnapshot.forEach((doc) => {
        let data = doc.data();
        data.id = doc.id; // Firestore doc ID
        cityData.push(data);
      });

      // Şehirleri seri'ye ekleyelim
      pointSeries.data.setAll(cityData);

      // Marker görünümleri
      pointSeries.bullets.push(() => {
        let container = am5.Container.new(root, {});
        let circle = container.children.push(
          am5.Graphics.new(root, {
            radius: 8,
            fill: am5.color(0xf5333f),
            cursorOverStyle: "pointer",
            tooltipText: "{name}"
          })
        );

        // Hover efekti
        circle.states.create("hover", {
          scale: 1.3,
          fill: am5.color(0xff7f50),
        });

        // Tıklama eventi
        circle.events.on("click", (e) => {
          let dataContext = e.target.dataItem.dataContext;
          openCityModal(dataContext);
        });

        return am5.Bullet.new(root, {
          sprite: container,
        });
      });
    }

    /**************************************************/
    /** Şehir Modal'ını Açma ve Verileri Gösterme     */
    /**************************************************/
    async function openCityModal(city) {
      // city objesinde: {name, price, latitude, longitude, ownerId, id} var
      selectedCityId = city.id;
      selectedCityPrice = city.price;

      cityNameEl.textContent = city.name;
      cityPriceEl.textContent = city.price + " USDT";

      if (!city.ownerId) {
        cityOwnerEl.textContent = "Henüz sahibi yok.";
      } else {
        // ownerId ile users koleksiyonundan kullanıcı adı alalım
        const ownerDoc = await db.collection("users").doc(city.ownerId).get();
        if (ownerDoc.exists) {
          const ownerData = ownerDoc.data();
          cityOwnerEl.textContent = ownerData.username;
        } else {
          cityOwnerEl.textContent = "Bilinmiyor";
        }
      }

      // Eğer şehir kullanıcıya ait ise "Satın Al" butonunu gizleyebiliriz (isteğe bağlı)
      if (city.ownerId === currentUser?.uid) {
        btnBuyCity.style.display = "none";
      } else {
        btnBuyCity.style.display = "inline-block";
      }

      cityModal.show();
    }

    /**************************************************/
    /** Şehir Satın Alma Butonu                       */
    /**************************************************/
    btnBuyCity.addEventListener("click", async () => {
      if (!currentUser || !selectedCityId) return;

      // Öncelikle kullanıcının güncel bakiyesini kontrol edelim
      const userRef = db.collection("users").doc(currentUser.uid);
      const userDoc = await userRef.get();
      const userData = userDoc.data();

      if (!userData) return alert("Kullanıcı bilgisi bulunamadı!");

      let balance = userData.balance || 0;
      if (balance < selectedCityPrice) {
        return alert("Yetersiz bakiye!");
      }

      // Şehir bilgisini çekelim
      const cityRef = db.collection("cities").doc(selectedCityId);
      const cityDoc = await cityRef.get();
      if (!cityDoc.exists) {
        return alert("Şehir bulunamadı!");
      }

      const cityData = cityDoc.data();
      // Zaten sahibiyse engelle (isteğe bağlı)
      if (cityData.ownerId) {
        return alert("Şehir zaten satılmış!");
      }

      // İşlem: Kullanıcının bakiyesini düşür, şehrin ownerId'sini ayarla, kullanıcının cities listesine ekle
      // Firestore Transaction veya Batch ile yapmak daha güvenlidir.
      await db.runTransaction(async (transaction) => {
        const freshUserDoc = await transaction.get(userRef);
        const freshCityDoc = await transaction.get(cityRef);

        if (!freshUserDoc.exists || !freshCityDoc.exists) {
          throw "Geçersiz kullanıcı veya şehir!";
        }

        let freshUserData = freshUserDoc.data();
        let freshCityData = freshCityDoc.data();

        // Tekrar bakiye kontrolü
        if (freshUserData.balance < selectedCityPrice) {
          throw "Yetersiz bakiye!";
        }

        // Şehir boşta mı?
        if (freshCityData.ownerId) {
          throw "Şehir zaten satılmış!";
        }

        // Bakiye düş
        let newBalance = freshUserData.balance - selectedCityPrice;
        // Şehir listesini güncelle
        let userCities = freshUserData.cities || [];
        userCities.push(freshCityData.name);

        // Güncellemeleri yap
        transaction.update(userRef, {
          balance: newBalance,
          cities: userCities,
        });
        transaction.update(cityRef, {
          ownerId: currentUser.uid,
        });
      });

      alert("Satın alma işlemi başarılı!");
      cityModal.hide();
      // Haritayı tekrar çizerek son durumları güncelleyebilirsiniz (örn: marker rengi değiştirilebilir).
      renderMap();
    });
  </script>
</body>
</html>
