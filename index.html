<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Harita Oyunu</title>
  
  <!-- Bootstrap 5 CSS -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <!-- amCharts 5 -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

  <!-- Firebase (Compat Sürümleri) -->
  <script src="https://www.gstatic.com/firebasejs/9.6.4/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.4/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.4/firebase-firestore-compat.js"></script>

  <style>
    /* Tam ekran harita için body ve html sıfırlama */
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      width: 100%;
      overflow: hidden; /* Sayfa kaydırma çubuklarını gizlemek için */
    }
    /* Harita kapsayıcı */
    #chartdiv {
      width: 100%;
      height: 100%;
    }
    /* Modal içindeki form alanları vs. ek tasarımlar */
    .modal-header {
      background-color: #f5f5f5;
    }
    .modal-footer button {
      margin-left: 5px;
    }
    .nav-link {
      cursor: pointer;
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Harita Oyunu</span>
    
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item d-none" id="navProfile">
          <a class="nav-link" data-bs-toggle="modal" data-bs-target="#profileModal">
            Profil
          </a>
        </li>
        <li class="nav-item d-none" id="navLogout">
          <a class="nav-link" id="logoutBtn">
            Çıkış Yap
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>
  
<!-- Harita kapsayıcı -->
<div id="chartdiv"></div>

<!-- Giriş/Kayıt Modal -->
<div
  class="modal fade"
  id="authModal"
  tabindex="-1"
  aria-labelledby="authModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="authModalLabel">Kullanıcı Girişi / Kaydı</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Kapat"
        ></button>
      </div>
      <div class="modal-body">
        <!-- Kayıt Formu -->
        <div id="registerForm" style="display: none;">
          <div class="mb-3">
            <label for="registerUsername" class="form-label">Kullanıcı Adı</label>
            <input type="text" class="form-control" id="registerUsername" />
          </div>
          <div class="mb-3">
            <label for="registerEmail" class="form-label">E-Posta</label>
            <input type="email" class="form-control" id="registerEmail" />
          </div>
          <div class="mb-3">
            <label for="registerPassword" class="form-label">Şifre (min. 6 karakter)</label>
            <input type="password" class="form-control" id="registerPassword" />
          </div>
          <button class="btn btn-primary w-100" id="signUpBtn">
            Kayıt Ol
          </button>
          <p class="text-center mt-3">
            Zaten hesabınız var mı?
            <span class="text-primary" style="cursor:pointer;" id="goToLogin">
              Giriş Yap
            </span>
          </p>
        </div>

        <!-- Giriş Formu -->
        <div id="loginForm">
          <div class="mb-3">
            <label for="loginEmail" class="form-label">E-Posta</label>
            <input type="email" class="form-control" id="loginEmail" />
          </div>
          <div class="mb-3">
            <label for="loginPassword" class="form-label">Şifre</label>
            <input type="password" class="form-control" id="loginPassword" />
          </div>
          <button class="btn btn-success w-100" id="loginBtn">
            Giriş Yap
          </button>
          <p class="text-center mt-3">
            Henüz hesabınız yok mu?
            <span class="text-primary" style="cursor:pointer;" id="goToRegister">
              Kayıt Ol
            </span>
          </p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Profil Modal -->
<div
  class="modal fade"
  id="profileModal"
  tabindex="-1"
  aria-labelledby="profileModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Profil Bilgileri</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Kapat"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Kullanıcı Adı:</strong> <span id="profileUsername"></span></p>
        <p><strong>Bakiye (USDT):</strong> <span id="profileBalance"></span></p>
        <p><strong>Sahip Olduğunuz Şehirler:</strong></p>
        <ul id="profileCities"></ul>
      </div>
    </div>
  </div>
</div>

<!-- Şehir Detay Modal -->
<div
  class="modal fade"
  id="cityDetailModal"
  tabindex="-1"
  aria-labelledby="cityDetailModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cityDetailModalLabel">Şehir Detayları</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Kapat"
        ></button>
      </div>
      <div class="modal-body">
        <p><strong>Şehir Adı:</strong> <span id="modalCityName"></span></p>
        <p><strong>Fiyat (USDT):</strong> <span id="modalCityPrice"></span></p>
        <p><strong>Mevcut Sahibi:</strong> <span id="modalCityOwner"></span></p>
      </div>
      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-primary"
          id="buyCityBtn"
          data-city-id=""
        >
          Satın Al
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS (Popper dahil) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
/* 
  Firebase Configinizi aşağıdaki gibi kendinize göre düzenleyin.
  Firebase projenizden aldığınız değerleri yerleştirin.
*/
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "your-project.firebaseapp.com",
  projectId: "your-project-id",
  storageBucket: "your-project.appspot.com",
  messagingSenderId: "your-messaging-sender-id",
  appId: "your-app-id"
};

// Firebase Başlatma
firebase.initializeApp(firebaseConfig);

// Firebase Servisleri
const auth = firebase.auth();
const db = firebase.firestore();

// Modal referansları (Bootstrap modallarını kontrol etmek için)
const authModal = new bootstrap.Modal(document.getElementById('authModal'), {
  backdrop: 'static',
  keyboard: false
});
const profileModal = new bootstrap.Modal(document.getElementById('profileModal'));
const cityDetailModal = new bootstrap.Modal(document.getElementById('cityDetailModal'));

// Navbar öğeleri
const navProfile = document.getElementById('navProfile');
const navLogout = document.getElementById('navLogout');

// Auth Modal içi öğeler
const registerForm = document.getElementById('registerForm');
const loginForm = document.getElementById('loginForm');
const goToLogin = document.getElementById('goToLogin');
const goToRegister = document.getElementById('goToRegister');
const signUpBtn = document.getElementById('signUpBtn');
const loginBtn = document.getElementById('loginBtn');

// Form alanları
const registerUsername = document.getElementById('registerUsername');
const registerEmail = document.getElementById('registerEmail');
const registerPassword = document.getElementById('registerPassword');
const loginEmail = document.getElementById('loginEmail');
const loginPassword = document.getElementById('loginPassword');

// Profil Modal öğeleri
const profileUsername = document.getElementById('profileUsername');
const profileBalance = document.getElementById('profileBalance');
const profileCities = document.getElementById('profileCities');

// Şehir Detay Modal öğeleri
const modalCityName = document.getElementById('modalCityName');
const modalCityPrice = document.getElementById('modalCityPrice');
const modalCityOwner = document.getElementById('modalCityOwner');
const buyCityBtn = document.getElementById('buyCityBtn');

/* 
  Uygulama ilk kez çalıştığında şehir verileri yoksa 
  seed (örnek) şehir verilerini Firestore'a ekleyeceğiz.
*/
async function seedCities() {
  const citiesRef = db.collection('cities');
  const snapshot = await citiesRef.get();

  if (snapshot.empty) {
    // Örnek şehir verileri
    const seedData = [
      {
        name: "İstanbul",
        price: 100,
        ownerId: null,
        latitude: 41.015137,
        longitude: 28.979530
      },
      {
        name: "Ankara",
        price: 80,
        ownerId: null,
        latitude: 39.92077,
        longitude: 32.85411
      },
      {
        name: "İzmir",
        price: 70,
        ownerId: null,
        latitude: 38.41885,
        longitude: 27.12872
      }
    ];

    // Batch işlemiyle ekle
    const batch = db.batch();
    seedData.forEach((city) => {
      const docRef = citiesRef.doc();
      batch.set(docRef, city);
    });
    await batch.commit();
    console.log("Örnek şehir verileri Firestore'a eklendi.");
  }
}

/* 
  amCharts 5 ile tam ekran haritayı oluşturma 
  ve Firestore'dan şehir verilerini çekerek marker ekleme
*/
async function createMap() {
  // Şehir verilerini al
  const cities = await db.collection('cities').get();

  // Harita oluşturma
  am5.ready(function() {
    // Root oluştur
    const root = am5.Root.new("chartdiv");

    // Tema ekleyelim (opsiyonel)
    root.setThemes([ am5themes_Animated.new(root) ]);

    // Harita şeması oluştur
    const chart = root.container.children.push(
      am5map.MapChart.new(root, {
        panX: "none",
        panY: "none",
        wheelX: "none",
        wheelY: "none",
        projection: am5map.geoMercator()
      })
    );

    // Dünya haritası polygon layer
    const polygonSeries = chart.series.push(
      am5map.MapPolygonSeries.new(root, {
        geoJSON: am5geodata_worldLow
      })
    );

    // Marker layer (Point Series)
    const pointSeries = chart.series.push(
      am5map.MapPointSeries.new(root, {})
    );

    // Şehir verileri ile marker oluştur
    cities.forEach(doc => {
      const city = doc.data();
      pointSeries.data.push({
        geometry: {
          type: "Point",
          coordinates: [ city.longitude, city.latitude ]
        },
        id: doc.id,
        name: city.name,
        price: city.price,
        ownerId: city.ownerId
      });
    });

    // Marker tasarımı
    pointSeries.bullets.push(function() {
      const circle = am5.Circle.new(root, {
        radius: 5,
        tooltipText: "{name}",
        fill: am5.color(0xff0000),
        cursorOverStyle: "pointer"
      });

      circle.events.on("pointerover", function(ev) {
        circle.set("scale", 1.5);
      });
      circle.events.on("pointerout", function(ev) {
        circle.set("scale", 1);
      });

      // Marker tıklanınca şehir detayı modalı aç
      circle.events.on("click", function(ev) {
        const data = ev.target.dataItem.dataContext;
        showCityDetailModal(data);
      });

      return am5.Bullet.new(root, {
        sprite: circle
      });
    });
  });
}

// Şehir Detay Modal verilerini doldurma ve açma
function showCityDetailModal(cityData) {
  modalCityName.textContent = cityData.name;
  modalCityPrice.textContent = cityData.price;
  modalCityOwner.textContent = cityData.ownerId ? cityData.ownerId : "Sahipsiz";
  buyCityBtn.setAttribute('data-city-id', cityData.id);

  cityDetailModal.show();
}

/* 
  Şehir satın alma işlemi:
  - Kullanıcının Firestore'daki bakiyesini kontrol et
  - Yeterli ise şehir ownerId güncelle
  - Kullanıcının bakiyesini düş
  - Kullanıcının şehir listesine ekle
*/
buyCityBtn.addEventListener('click', async () => {
  const cityId = buyCityBtn.getAttribute('data-city-id');
  const user = auth.currentUser;

  if (!user) {
    alert("Şehir satın almak için önce giriş yapmalısınız.");
    return;
  }

  // Kullanıcı ve şehir bilgilerini çek
  const userDocRef = db.collection('users').doc(user.uid);
  const cityDocRef = db.collection('cities').doc(cityId);

  try {
    const [userDoc, cityDoc] = await Promise.all([
      userDocRef.get(),
      cityDocRef.get()
    ]);

    if (!userDoc.exists) {
      alert("Kullanıcı bilgileri bulunamadı.");
      return;
    }
    if (!cityDoc.exists) {
      alert("Şehir bilgisi bulunamadı.");
      return;
    }

    const userData = userDoc.data();
    const cityData = cityDoc.data();

    // Mevcut sahibi kontrolü
    if (cityData.ownerId && cityData.ownerId !== user.uid) {
      alert("Bu şehir başka birine ait!");
      return;
    }

    if (userData.balance >= cityData.price) {
      // Satın al
      await db.runTransaction(async (transaction) => {
        const freshUserDoc = await transaction.get(userDocRef);
        const freshCityDoc = await transaction.get(cityDocRef);

        // Tekrar kontrol (veri değişmiş olabilir)
        const freshUserData = freshUserDoc.data();
        const freshCityData = freshCityDoc.data();

        if (!freshCityData.ownerId || freshCityData.ownerId === user.uid) {
          const newBalance = freshUserData.balance - freshCityData.price;
          transaction.update(userDocRef, {
            balance: newBalance,
            ownedCities: firebase.firestore.FieldValue.arrayUnion(cityId)
          });
          transaction.update(cityDocRef, {
            ownerId: user.uid
          });
        } else {
          throw new Error("Şehir başka birine ait oldu.");
        }
      });

      alert("Şehir başarıyla satın alındı!");
      cityDetailModal.hide();
    } else {
      alert("Yeterli bakiyeniz yok!");
    }
  } catch (error) {
    console.error("Satın alma hata:", error);
    alert("Satın alma sırasında bir hata oluştu: " + error.message);
  }
});

/* 
  Kullanıcı durumunu dinle:
  - Giriş yapmadıysa Auth Modal aç
  - Giriş yaptıysa Profil ve Çıkış butonunu göster
*/
auth.onAuthStateChanged(async (user) => {
  if (user) {
    // Navbar öğelerini göster
    navProfile.classList.remove('d-none');
    navLogout.classList.remove('d-none');

    // Kayıt/Giriş modali açık ise kapat
    authModal.hide();

    // Kullanıcının Firestore'daki dokümanı var mı kontrol et, yoksa oluştur
    const userDocRef = db.collection('users').doc(user.uid);
    const userDoc = await userDocRef.get();
    if (!userDoc.exists) {
      // Yeni kullanıcı için varsayılan bakiye ve boş şehir listesi
      await userDocRef.set({
        username: user.displayName || "Bilinmiyor",
        email: user.email,
        balance: 200, // Örnek bakiye
        ownedCities: []
      });
    }
  } else {
    // Profil & Çıkış butonlarını gizle
    navProfile.classList.add('d-none');
    navLogout.classList.add('d-none');
    // Giriş yapmamış kullanıcı için Auth Modal aç
    authModal.show();
  }
});

/* 
  Kayıt Ol - Firebase Authentication
  - Yeni kullanıcı oluştur
  - Ardından displayName güncelle (opsiyonel)
*/
signUpBtn.addEventListener('click', async () => {
  const email = registerEmail.value.trim();
  const password = registerPassword.value.trim();
  const username = registerUsername.value.trim();

  if (!email || !password || !username) {
    alert("Lütfen tüm alanları doldurun.");
    return;
  }
  if (password.length < 6) {
    alert("Şifreniz en az 6 karakter olmalı.");
    return;
  }

  try {
    const userCredential = await auth.createUserWithEmailAndPassword(email, password);
    if (userCredential.user) {
      // DisplayName güncelle
      await userCredential.user.updateProfile({
        displayName: username
      });
      alert("Kayıt başarılı. Artık giriş yapabilirsiniz.");
    }
  } catch (error) {
    alert("Kayıt sırasında bir hata oluştu: " + error.message);
  }
});

/* Giriş Yap */
loginBtn.addEventListener('click', async () => {
  const email = loginEmail.value.trim();
  const password = loginPassword.value.trim();

  if (!email || !password) {
    alert("Lütfen e-posta ve şifrenizi girin.");
    return;
  }
  try {
    await auth.signInWithEmailAndPassword(email, password);
  } catch (error) {
    alert("Giriş hatası: " + error.message);
  }
});

/* Çıkış Yap */
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await auth.signOut();
});

/* Profil Modal açıldığında kullanıcı verilerini göster */
document.getElementById('navProfile').addEventListener('click', async () => {
  const user = auth.currentUser;
  if (!user) return;

  const userDocRef = db.collection('users').doc(user.uid);
  const userDoc = await userDocRef.get();
  if (userDoc.exists) {
    const data = userDoc.data();
    profileUsername.textContent = data.username;
    profileBalance.textContent = data.balance;
    // Sahip olduğu şehirler
    profileCities.innerHTML = '';
    if (data.ownedCities && data.ownedCities.length > 0) {
      for (const cityId of data.ownedCities) {
        // Şehir ismi almak için cityId dokümanını çek
        const cityDoc = await db.collection('cities').doc(cityId).get();
        if (cityDoc.exists) {
          const cityData = cityDoc.data();
          const li = document.createElement('li');
          li.textContent = cityData.name;
          profileCities.appendChild(li);
        }
      }
    } else {
      const li = document.createElement('li');
      li.textContent = "Henüz şehir sahibi değilsiniz.";
      profileCities.appendChild(li);
    }
  }
});

/* Auth Modal geçişleri (Kayıt <-> Giriş Formu) */
goToLogin.addEventListener('click', () => {
  registerForm.style.display = 'none';
  loginForm.style.display = 'block';
});

goToRegister.addEventListener('click', () => {
  loginForm.style.display = 'none';
  registerForm.style.display = 'block';
});

/* Sayfa yüklendiğinde şehir verilerini seed edip haritayı oluştur */
window.addEventListener('load', async () => {
  await seedCities();
  createMap();
});
</script>
</body>
</html>
