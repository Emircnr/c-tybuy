<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>amCharts + Firebase + Bootstrap - Tam Örnek</title>

  <!-- Bootstrap 5 CSS (CDN) -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />

  <!-- amCharts 5 Kütüphaneleri -->
  <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/map.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/worldLow.js"></script>
  <script src="https://cdn.amcharts.com/lib/5/geodata/data/countries2.js"></script>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

  <style>
    html, body {
      width: 100%;
      height: 100%;
      margin: 0; padding: 0;
      font-family: "Segoe UI", sans-serif;
      background: #f8f9fa;
    }
    #chartdiv {
      width: 100%;
      height: 100%;
      position: relative;
      background-color: #fff;
    }
    /* Üstteki sabit navbar gibi alan */
    .navbar {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      z-index: 9999;
    }
    /* Modal içeriklerinde ufak estetik */
    .modal-header {
      border-bottom: 1px solid #dee2e6;
    }
    .modal-footer {
      border-top: 1px solid #dee2e6;
    }
    /* Şehir noktalarının haritada belirginliği */
    .am5map-point {
      transition: transform 0.2s ease;
    }
    .am5map-point:hover {
      transform: scale(1.2);
    }
  </style>
</head>

<body>

<!-- NAVBAR (Bootstrap) -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Harita Uygulaması</span>
    <div class="d-flex">
      <!-- Profil Butonu, başlangıçta gizli, JS ile kontrol edilecek -->
      <button id="profileBtn" class="btn btn-success me-2" style="display:none;">
        Profil
      </button>
      <button id="logoutBtn" class="btn btn-danger" style="display:none;">
        Çıkış Yap
      </button>
    </div>
  </div>
</nav>

<!-- Harita Konteyneri -->
<div id="chartdiv"></div>

<!-- Kayıt/Giriş Modal (Bootstrap) -->
<div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="authModalLabel">Giriş / Kayıt Ol</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="authUsername" class="form-label">Kullanıcı Adı (Kayıt için)</label>
          <input type="text" class="form-control" id="authUsername" placeholder="Kullanıcı Adı">
        </div>
        <div class="mb-3">
          <label for="authEmail" class="form-label">E-Posta</label>
          <input type="email" class="form-control" id="authEmail" placeholder="Email">
        </div>
        <div class="mb-3">
          <label for="authPassword" class="form-label">Şifre (min. 6 karakter)</label>
          <input type="password" class="form-control" id="authPassword" placeholder="Şifre">
        </div>
      </div>
      <div class="modal-footer">
        <button id="loginBtn" class="btn btn-primary">Giriş Yap</button>
        <button id="registerBtn" class="btn btn-secondary">Kayıt Ol</button>
      </div>
    </div>
  </div>
</div>

<!-- Profil Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="profileModalLabel">Profil</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <p><strong>Kullanıcı Adı:</strong> <span id="profileUsername"></span></p>
        <p><strong>Sahip Olduğunuz Şehirler:</strong> <span id="profileOwnedCities"></span></p>
        <p><strong>Bakiye (USDT):</strong> <span id="profileBalance"></span></p>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<!-- Şehir Modal -->
<div class="modal fade" id="cityModal" tabindex="-1" aria-labelledby="cityModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cityModalLabel">Şehir Detayları</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Kapat"></button>
      </div>
      <div class="modal-body">
        <h5 id="cityTitle" class="mb-2"></h5>
        <p><strong>Fiyat:</strong> <span id="cityPrice"></span> USDT</p>
        <p><strong>Sahibi:</strong> <span id="cityOwner"></span></p>
      </div>
      <div class="modal-footer">
        <button id="buyCityBtn" class="btn btn-success">Satın Al</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Kapat</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap 5 JS (CDN) -->
<script 
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js">
</script>

<script>
/* -------------------------------------------------------------------------
   1) Firebase Ayarları 
------------------------------------------------------------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyDThNGVa7YBhQIINuIOxUiLbTvu0cOZh4w",
  authDomain: "maping-c0315.firebaseapp.com",
  databaseURL: "https://maping-c0315-default-rtdb.firebaseio.com",
  projectId: "maping-c0315",
  storageBucket: "maping-c0315.firebasestorage.app",
  messagingSenderId: "1056086990632",
  appId: "1:1056086990632:web:1f83946cad5b68e2f73a1d",
  measurementId: "G-3N34BTYV8C"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* -------------------------------------------------------------------------
   2) Genel Değişkenler 
------------------------------------------------------------------------- */
let currentUserData = null; // Kullanıcının Firestore verisi
let selectedCity = null;    // En son tıklanan şehir

// Bootstrap modal referansları
const authModal = new bootstrap.Modal(document.getElementById('authModal'), {backdrop: 'static'});
const profileModal = new bootstrap.Modal(document.getElementById('profileModal'), {backdrop: true});
const cityModal = new bootstrap.Modal(document.getElementById('cityModal'), {backdrop: true});

/* -------------------------------------------------------------------------
   3) Kayıt / Giriş Fonksiyonları
------------------------------------------------------------------------- */
async function registerUser() {
  const username = document.getElementById('authUsername').value.trim();
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value.trim();

  if (!username || !email || !password) {
    alert("Kullanıcı adı, e-posta ve şifre giriniz!");
    return;
  }
  if (password.length < 6) {
    alert("Şifre en az 6 karakter olmalı!");
    return;
  }

  try {
    const userCred = await auth.createUserWithEmailAndPassword(email, password);
    const user = userCred.user;
    // Firestore'a ekle
    await db.collection("users").doc(user.uid).set({
      username: username,
      email: email,
      balance: 5000,      // Örnek başlangıç bakiyesi
      ownedCities: []
    });
    authModal.hide();
    alert("Kayıt başarılı!");
  } catch (err) {
    alert("Kayıt hatası: " + err.message);
  }
}

async function loginUser() {
  const email = document.getElementById('authEmail').value.trim();
  const password = document.getElementById('authPassword').value.trim();
  if (!email || !password) {
    alert("E-posta ve şifre boş olamaz!");
    return;
  }
  try {
    await auth.signInWithEmailAndPassword(email, password);
    authModal.hide();
    alert("Giriş başarılı!");
  } catch (err) {
    alert("Giriş hatası: " + err.message);
  }
}

function logoutUser() {
  auth.signOut();
}

/* -------------------------------------------------------------------------
   4) Auth State: Giriş/Çıkış olduğu an
------------------------------------------------------------------------- */
auth.onAuthStateChanged(async (user) => {
  if (user) {
    // Kullanıcı giriş yaptı, Firestore'dan verileri çek
    const docSnap = await db.collection("users").doc(user.uid).get();
    if (docSnap.exists) {
      currentUserData = docSnap.data();
      document.getElementById("profileBtn").style.display = "inline-block";
      document.getElementById("logoutBtn").style.display = "inline-block";
      console.log("Giriş yaptı, userData:", currentUserData);
    }
  } else {
    // Kullanıcı çıkış yaptı
    currentUserData = null;
    document.getElementById("profileBtn").style.display = "none";
    document.getElementById("logoutBtn").style.display = "none";
    // Giriş yapmamışsa modal açalım
    authModal.show();
  }
});

/* -------------------------------------------------------------------------
   5) Profil Gösterme
------------------------------------------------------------------------- */
function showProfile() {
  if (!currentUserData) return;
  document.getElementById("profileUsername").innerText = currentUserData.username || "Bilinmiyor";
  const owned = currentUserData.ownedCities && currentUserData.ownedCities.length
    ? currentUserData.ownedCities.join(", ")
    : "Henüz şehir yok.";
  document.getElementById("profileOwnedCities").innerText = owned;
  document.getElementById("profileBalance").innerText = currentUserData.balance || 0;
  profileModal.show();
}

/* -------------------------------------------------------------------------
   6) Örnek Şehir Verileri Firestore'da Saklama
      - Uygulama ilk kez çalışırken Firestore'a kaydetmek için.
------------------------------------------------------------------------- */
let localCityData = [
  {
    id: "city_1",
    title: "İstanbul",
    latitude: 41.0082,
    longitude: 28.9784,
    price: 1200,
    ownerId: null
  },
  {
    id: "city_2",
    title: "Ankara",
    latitude: 39.9208,
    longitude: 32.8541,
    price: 900,
    ownerId: null
  },
  {
    id: "city_3",
    title: "İzmir",
    latitude: 38.4237,
    longitude: 27.1428,
    price: 750,
    ownerId: null
  }
];

async function seedCityDataIfNeeded() {
  // 'cities' koleksiyonunda city_1 var mı diye bakalım
  const ref = db.collection("cities").doc("city_1");
  const snap = await ref.get();
  if (!snap.exists) {
    // YOKSA, local veriyi kaydedelim
    for (let city of localCityData) {
      await db.collection("cities").doc(city.id).set(city);
    }
    console.log("Cities seeded to Firestore");
  } else {
    console.log("Cities already exist in Firestore");
  }
}

/* -------------------------------------------------------------------------
   7) Firestore'dan Şehirleri Çekme ve Harita Üzerinde Gösterme
------------------------------------------------------------------------- */
let citySeries; // amCharts MapPointSeries

async function loadCitiesAndRenderMap(chart) {
  const cityDocs = await db.collection("cities").get();
  let cityData = [];
  cityDocs.forEach((doc) => {
    cityData.push(doc.data());
  });

  // MapPointSeries'e verileri ata
  citySeries = chart.series.push(am5map.MapPointSeries.new(chart._root, {}));
  citySeries.bullets.push(function () {
    let circle = am5.Circle.new(chart._root, {
      radius: 6,
      fill: am5.color(0xff0000),
      tooltipText: "{title}",
      cursorOverStyle: "pointer",
      className: "am5map-point"
    });
    circle.events.on("click", function(ev) {
      let dataItem = ev.target.dataItem;
      if (!dataItem) return;
      let cityInfo = dataItem.dataContext;
      openCityModal(cityInfo);
    });
    return am5.Bullet.new(chart._root, { sprite: circle });
  });

  // Datayı ekle
  citySeries.data.setAll(cityData);
}

/* -------------------------------------------------------------------------
   8) Harita Başlatma (amCharts 5)
------------------------------------------------------------------------- */
function initMap() {
  let root = am5.Root.new("chartdiv");
  root.setThemes([ am5themes_Animated.new(root) ]);

  let chart = root.container.children.push(
    am5map.MapChart.new(root, {
      projection: am5map.geoMercator(),
      panX: "rotateX"
    })
  );

  // Dünya poligonları
  let worldSeries = chart.series.push(
    am5map.MapPolygonSeries.new(root, {
      geoJSON: am5geodata_worldLow,
      exclude: ["AQ"] 
    })
  );
  worldSeries.mapPolygons.template.setAll({
    tooltipText: "{name}",
    fill: am5.color(0xcccccc)
  });

  // Firestore'dan şehirleri yükleyip ekle
  loadCitiesAndRenderMap(chart);

  chart.goHome();
}

/* -------------------------------------------------------------------------
   9) Şehir Modal
------------------------------------------------------------------------- */
function openCityModal(cityInfo) {
  selectedCity = cityInfo; // son tıklanan şehir
  document.getElementById("cityTitle").innerText = cityInfo.title;
  document.getElementById("cityPrice").innerText = cityInfo.price;
  if (cityInfo.ownerId) {
    document.getElementById("cityOwner").innerText = "Kullanıcı ID: " + cityInfo.ownerId;
  } else {
    document.getElementById("cityOwner").innerText = "Sahipsiz";
  }
  cityModal.show();
}

async function buyCity() {
  if (!selectedCity) return alert("Şehir seçili değil!");

  // Giriş yapmamış kullanıcı
  if (!auth.currentUser) {
    return alert("Şehir satın almak için önce giriş yapmalısınız.");
  }
  if (!currentUserData) {
    return alert("Kullanıcı verisi yüklenemedi!");
  }

  // Bakiyenin yeterli olup olmadığına bak
  if (currentUserData.balance < selectedCity.price) {
    return alert("Yetersiz bakiye. Bakiyeniz: " + currentUserData.balance);
  }

  // Şehir zaten birine aitse
  if (selectedCity.ownerId && selectedCity.ownerId !== auth.currentUser.uid) {
    return alert("Şehir başka kullanıcıya ait!");
  }
  // Aynı kullanıcıysa (zaten sahipseniz)
  if (selectedCity.ownerId === auth.currentUser.uid) {
    return alert("Bu şehre zaten sahipsiniz!");
  }

  try {
    // 1) Kullanıcının bakiyesini düş
    let newBalance = currentUserData.balance - selectedCity.price;

    // 2) Şehir ownerId güncelle
    const cityRef = db.collection("cities").doc(selectedCity.id);
    await cityRef.update({
      ownerId: auth.currentUser.uid
    });

    // 3) Kullanıcının ownedCities listesine ekle
    let newOwnedCities = currentUserData.ownedCities || [];
    newOwnedCities.push(selectedCity.title);

    // 4) Firestore'da user dokümanını güncelle
    const userRef = db.collection("users").doc(auth.currentUser.uid);
    await userRef.update({
      balance: newBalance,
      ownedCities: newOwnedCities
    });

    // Lokal verileri güncelle
    currentUserData.balance = newBalance;
    currentUserData.ownedCities = newOwnedCities;
    selectedCity.ownerId = auth.currentUser.uid;

    alert(selectedCity.title + " şehrini satın aldınız!");
    cityModal.hide();
  } catch (err) {
    console.error(err);
    alert("Satın alma işleminde hata: " + err.message);
  }
}

/* -------------------------------------------------------------------------
   10) window.onload
------------------------------------------------------------------------- */
window.onload = async function() {
  // 1) Eğer Firestore'da şehir yoksa önden ekleyelim (seed)
  await seedCityDataIfNeeded();
  // 2) Haritayı başlat
  initMap();

  // Buton eventleri
  document.getElementById("registerBtn").addEventListener("click", registerUser);
  document.getElementById("loginBtn").addEventListener("click", loginUser);

  document.getElementById("logoutBtn").addEventListener("click", logoutUser);
  document.getElementById("profileBtn").addEventListener("click", showProfile);
  document.getElementById("buyCityBtn").addEventListener("click", buyCity);
};
</script>
</body>
</html>
