<!DOCTYPE html>
<html lang="tr" class="theme-dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Arbitraj Radarı — Paribu ⇄ Binance (TL)</title>
<style>
  /* ===== Temalar ===== */
  .theme-dark{
    --bg:#0b1220; --panel:#111a2b; --panel2:#0f1626; --text:#e6edf6;
    --muted:#9fb0ca; --accent:#60a5fa; --border:#17243e;
    --headerStart:#0e172a; --headerEnd:#0b1220;
    --chipBg:#1a243e; --chipBorder:#2a3d64;
    --greenBg:#0f2a1b; --greenBd:#184a2b; --greenTx:#b6f7c8;
  }
  .theme-light{
    --bg:#ffffff; --panel:#f3f6fb; --panel2:#ffffff; --text:#0b1220;
    --muted:#4a5568; --accent:#2563eb; --border:#d7deea;
    --headerStart:#eaf1ff; --headerEnd:#ffffff;
    --chipBg:#eef3ff; --chipBorder:#c8d6f5;
    --greenBg:#e9f8ef; --greenBd:#b9e5c8; --greenTx:#166534;
  }

  /* ===== Kişiselleştirme değişkenleri ===== */
  :root{
    --table-font:18px;
    --cell-pad-y:12px;
    --cell-pad-x:10px;
    --row-gap:6px;
    --cell-radius:12px;
    --container-max:1100px;
    --col-coin:28%;
    --col-al:27%;
    --col-sat:27%;
    --col-pct:18%;
    --card-font:22px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:linear-gradient(180deg,var(--headerStart),var(--headerEnd));border-bottom:1px solid var(--border)}
  header h1{margin:0;font-size:20px}
  header .sub{color:var(--muted);font-size:12px}
  header .rightBox{display:flex;gap:14px;align-items:center}
  .btn{background:var(--accent);color:#091220;border:none;border-radius:10px;padding:10px 12px;font-weight:600;cursor:pointer}
  .ghost{background:var(--panel);color:var(--text);border:1px solid var(--border)}

  /* En Yüksek Fark — sade tek satır */
  .hiWrap{padding:10px 16px}
  .hidden{display:none}
  .hiLine{
    font-size:var(--card-font);font-weight:800;letter-spacing:.2px;
    background:var(--panel2);border:1px solid var(--border);
    border-left:6px solid #22c55e;border-radius:14px;padding:10px 14px;display:flex;gap:10px;align-items:baseline;flex-wrap:wrap
  }
  .hiGreen{background:var(--greenBg);border:1px solid var(--greenBd);color:var(--greenTx);
    border-radius:999px;padding:4px 10px;font-weight:800}

  /* Üst kontrol şeritleri */
  .controls{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:12px;padding:12px 16px;background:var(--panel);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  .ctrl{background:var(--panel2);border:1px solid var(--border);border-radius:12px;padding:10px}
  .ctrl label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"], input[type="number"], select{
    width:100%;background:var(--panel2);border:1px solid var(--border);color:var(--text);
    border-radius:10px;padding:10px 12px;font-size:14px;outline:none
  }
  input[type="range"]{width:100%}

  .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
  .chip{display:inline-flex;gap:6px;align-items:center;background:var(--chipBg);border:1px solid var(--chipBorder);border-radius:999px;padding:5px 10px;font-size:12px}
  .chip button{all:unset;cursor:pointer;color:#4f79ff}

  /* TABLO */
  .tableWrap{padding:12px 16px;max-width:var(--container-max);margin:0 auto}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--row-gap);table-layout:fixed}
  thead th{font-size:calc(var(--table-font) - 4px);color:var(--muted);text-align:center;padding:0 8px}
  thead th:first-child{text-align:left}
  tbody tr{background:var(--panel2);border:1px solid var(--border)}
  tbody td{padding:var(--cell-pad-y) var(--cell-pad-x);font-size:var(--table-font)}
  tbody tr td:first-child{border-top-left-radius:var(--cell-radius);border-bottom-left-radius:var(--cell-radius)}
  tbody tr td:last-child{border-top-right-radius:var(--cell-radius);border-bottom-right-radius:var(--cell-radius)}
  .mono{font-variant-numeric:tabular-nums; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace}
  .muted{color:var(--muted)}
  .coinCell{display:flex;align-items:center;gap:10px}
  .coinSym{font-weight:800}
  .alCell,.satCell,.pctCell{text-align:center;font-weight:800}

  /* ========== KİŞİSELLEŞTİR paneli ========== */
  .customWrap{padding:10px 16px}
  .customPanel{
    background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:14px;display:grid;gap:12px
  }
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  .rowLabel{font-size:12px;color:var(--muted);margin-bottom:4px}
  .kv{display:flex;align-items:center;gap:8px}
  .kv .val{font-size:12px;color:var(--muted);min-width:48px;text-align:right}
  .footerBtns{display:flex;gap:8px;justify-content:flex-end}
</style>
</head>
<body>
<header>
  <div>
    <h1>Arbitraj Radarı — Paribu ⇄ Binance (TL)</h1>
    <div class="sub">
      <span id="usdBox">USDT→TRY: <span id="usdtry" class="mono">—</span></span>
      · Son: <span id="last" class="mono">—</span>
    </div>
  </div>
  <div class="rightBox">
    <div id="btcBox" class="sub">BTCUSDT: <span id="btc" class="mono">—</span></div>
    <div class="sub">Paribu WS: <span id="pws">—</span> · Binance WS: <span id="bws">—</span></div>
    <button id="toggleHi" class="btn ghost">En Yüksek Fark: Açık</button>
    <button id="toggleCustom" class="btn ghost">Kişiselleştir: Kapalı</button>
    <div class="sub">İzlenen: <span id="cnt">0</span> · Hata: <span id="err">0</span></div>
  </div>
</header>

<!-- Highlight kartı -->
<div id="anchorTop"></div>
<section id="hiWrap" class="hiWrap">
  <div class="hiLine">
    <span id="hiCoin">—</span>
    <span class="hiGreen" id="hiAct">PARİBU • —</span>
    <span id="hiPrice" class="mono">—</span>
    <span id="hiPct" class="mono">—</span>
  </div>
</section>

<!-- Kontroller -->
<section class="controls">
  <div class="ctrl">
    <label>Coin Ekle / Çıkar</label>
    <div class="row">
      <input id="coinIn" type="text" placeholder="Örn: ZIL, XAI, MINA"/>
      <button id="add" class="btn">Ekle</button>
      <button id="clear" class="btn ghost">Temizle</button>
    </div>
    <div id="chips" class="chips"></div>
  </div>

  <div class="ctrl">
    <label>Yenileme Aralığı (0.1–4.0 sn)</label>
    <div class="row">
      <input id="rng" type="range" min="100" max="4000" step="100">
      <div class="mono" id="rngLbl">—</div>
    </div>
    <div class="muted" style="font-size:12px;margin-top:6px">Hesap periyodu (WS sürekli akar).</div>
  </div>

  <div class="ctrl">
    <label>Min. % Fark (filtre)</label>
    <div class="row">
      <input id="minPct" type="number" step="0.01" min="0" value="0.00"/>
    </div>
    <div class="muted" style="font-size:12px;margin-top:6px">Bu eşiği aşmayan satırlar listelenmez.</div>
  </div>

  <div class="ctrl">
    <label>Tema</label>
    <div class="row">
      <select id="themeSel">
        <option value="dark">Koyu</option>
        <option value="light">Açık</option>
      </select>
    </div>
    <div class="muted" style="font-size:12px;margin-top:6px">Arka planı beyaz yapmak için “Açık” temayı seç.</div>
  </div>
</section>

<!-- Kişiselleştir paneli -->
<section id="customWrap" class="customWrap hidden">
  <div class="customPanel">
    <div class="grid3">
      <div>
        <div class="rowLabel">Tablo Yazı Boyutu</div>
        <div class="kv">
          <input id="ui_tableFont" type="range" min="14" max="26" step="1">
          <span class="val" id="ui_tableFont_val"></span>
        </div>
      </div>
      <div>
        <div class="rowLabel">Satır İç Boşluk (Y)</div>
        <div class="kv">
          <input id="ui_padY" type="range" min="6" max="24" step="1">
          <span class="val" id="ui_padY_val"></span>
        </div>
      </div>
      <div>
        <div class="rowLabel">Satır İç Boşluk (X)</div>
        <div class="kv">
          <input id="ui_padX" type="range" min="6" max="24" step="1">
          <span class="val" id="ui_padX_val"></span>
        </div>
      </div>
    </div>

    <div class="grid3">
      <div>
        <div class="rowLabel">Satır Boşluğu (Gap)</div>
        <div class="kv">
          <input id="ui_rowGap" type="range" min="0" max="20" step="1">
          <span class="val" id="ui_rowGap_val"></span>
        </div>
      </div>
      <div>
        <div class="rowLabel">Köşe Radius</div>
        <div class="kv">
          <input id="ui_radius" type="range" min="0" max="24" step="1">
          <span class="val" id="ui_radius_val"></span>
        </div>
      </div>
      <div>
        <div class="rowLabel">Tablo Genişliği (px)</div>
        <div class="kv">
          <input id="ui_maxW" type="range" min="800" max="1600" step="10">
          <span class="val" id="ui_maxW_val"></span>
        </div>
      </div>
    </div>

    <div>
      <div class="rowLabel">Sütun Genişlikleri (%) — toplam 100</div>
      <div class="grid4" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px">
        <div class="kv"><span class="val" style="min-width:auto">Coin</span><input id="ui_colCoin" type="number" min="10" max="60" step="1" style="width:80px"></div>
        <div class="kv"><span class="val" style="min-width:auto">AL</span><input id="ui_colAl" type="number" min="10" max="60" step="1" style="width:80px"></div>
        <div class="kv"><span class="val" style="min-width:auto">SAT</span><input id="ui_colSat" type="number" min="10" max="60" step="1" style="width:80px"></div>
        <div class="kv"><span class="val" style="min-width:auto">% Fark</span><input id="ui_colPct" type="number" min="10" max="60" step="1" style="width:80px"></div>
      </div>
      <div class="muted" id="ui_colSum" style="font-size:12px;margin-top:4px"></div>
    </div>

    <div class="grid2">
      <div>
        <div class="rowLabel">En Yüksek Fark Kartı Yazı Boyutu</div>
        <div class="kv">
          <input id="ui_cardFont" type="range" min="16" max="36" step="1">
          <span class="val" id="ui_cardFont_val"></span>
        </div>
      </div>
      <div>
        <div class="rowLabel">En Yüksek Fark Kartı Konumu</div>
        <select id="ui_hiPos">
          <option value="top">Üstte (Başlık altında)</option>
          <option value="afterControls">Kontrollerin altında</option>
          <option value="afterTable">Tablonun altında</option>
          <option value="hidden">Gizli</option>
        </select>
      </div>
    </div>

    <div class="grid3">
      <label class="kv" style="gap:6px"><input id="ui_showBTC" type="checkbox"> BTC Fiyatını Göster</label>
      <label class="kv" style="gap:6px"><input id="ui_showUSDT" type="checkbox" checked> USDT→TRY’yi Göster</label>
      <div></div>
    </div>

    <div class="footerBtns">
      <button id="ui_reset" class="btn ghost">Varsayılanlara Dön</button>
    </div>
  </div>
</section>

<!-- Tablonun kancaları -->
<div id="anchorAfterControls"></div>

<section class="tableWrap">
  <table>
    <colgroup>
      <col id="colCoin" style="width:var(--col-coin);">
      <col id="colAl"   style="width:var(--col-al);">
      <col id="colSat"  style="width:var(--col-sat);">
      <col id="colPct"  style="width:var(--col-pct);">
    </colgroup>
    <thead>
      <tr>
        <th style="text-align:left">Coin</th>
        <th>AL</th>
        <th>SAT</th>
        <th>% Fark</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</section>

<!-- Tablonun altına yerleştirme için kanca -->
<div id="anchorAfterTable"></div>

<script>
/* ====== Yardımcılar + Kalıcı Hafıza ====== */
const $ = s => document.querySelector(s);
const LS = {
  get(key, def){ try{ const v = localStorage.getItem(key); return v==null ? def : JSON.parse(v); }catch{ return def; } },
  set(key, val){ try{ localStorage.setItem(key, JSON.stringify(val)); }catch{} }
};
function norm(sym){
  if(!sym) return '';
  return sym.trim().toUpperCase()
    .replaceAll('İ','I').replaceAll('İ','I')
    .replaceAll('Ç','C').replaceAll('Ğ','G').replaceAll('Ö','O').replaceAll('Ş','S').replaceAll('Ü','U');
}
function fmtFixedTR(n, d=2){ if(n==null || !isFinite(n)) return '—'; return Number(n).toLocaleString('tr-TR',{minimumFractionDigits:d, maximumFractionDigits:d}); }
function fmtPctTR(n, d=2){ if(n==null || !isFinite(n)) return '—'; return '%'+Number(n).toLocaleString('tr-TR',{minimumFractionDigits:d, maximumFractionDigits:d}); }
function fmt4(n){ return (n==null||!isFinite(n)) ? '—' : Number(n).toFixed(4); }
function nowStr(){ return new Date().toLocaleTimeString('tr-TR'); }

/* ====== Durum ====== */
let watched = new Set(LS.get('arbi:watched', []));
let refreshMs = Number(LS.get('arbi:interval', 1000));
let minPctFilter = Number(LS.get('arbi:minpct', 0.00));
let themeMode = LS.get('arbi:theme', 'dark');
let hiOn = LS.get('arbi:hiOn', true);

const UI_DEFAULTS = {
  tableFont: 18, padY: 12, padX: 10, rowGap: 6, radius: 12, maxW: 1100,
  col: { coin:28, al:27, sat:27, pct:18 },
  cardFont: 22, hiPos: 'top', showBTC: true, showUSDT: true
};
let UI = Object.assign({}, UI_DEFAULTS, LS.get('arbi:UI', UI_DEFAULTS));
if(!UI.col) UI.col = { coin:28, al:27, sat:27, pct:18 };

let timer = null, updating = false, errors = 0;
let usdtryBid = null, usdtryLast = null;

/* ====== UI Elemanları ====== */
const elUsd = $('#usdtry'), elUsdBox = $('#usdBox'), elLast = $('#last'), elCnt = $('#cnt'), elErr = $('#err'),
      elBody = $('#tbody'), elRngLbl = $('#rngLbl'), elRng = $('#rng'), elMin = $('#minPct'),
      elThemeSel = $('#themeSel'), elBtc = $('#btc'), elBtcBox = $('#btcBox'),
      elHiWrap = $('#hiWrap'), elHiCoin = $('#hiCoin'), elHiAct = $('#hiAct'),
      elHiPrice = $('#hiPrice'), elHiPct = $('#hiPct'), elHiToggle = $('#toggleHi'),
      elCustomWrap = $('#customWrap'), elCustomToggle = $('#toggleCustom'),
      elParibuWS = $('#pws'), elBinWS = $('#bws');

/* ====== PARIBU WS (public) ====== */
class ParibuWS {
  constructor(){
    this.url = 'wss://stream.paribu.com';
    this.ws = null;
    this.connected = false;
    this.retries = 0;
    this.wantSubs = new Set();
    this.books = new Map(); // market -> {b:Array<[p,qty]>, a:Array<[p,qty]>, t:number}
  }
  connect(){
    if(this.ws && (this.ws.readyState===WebSocket.OPEN || this.ws.readyState===WebSocket.CONNECTING)) return;
    try{
      this.ws = new WebSocket(this.url);
    }catch(e){ this._reconnect(); return; }
    elParibuWS.textContent = 'Bağlanıyor…';
    this.ws.onopen = () => {
      this.connected = true; this.retries = 0;
      elParibuWS.textContent = 'Bağlı';
      if(this.wantSubs.size>0) this._send({method:'subscribe', channels:[...this.wantSubs], id:'pinit_'+Date.now()});
    };
    this.ws.onclose = () => { this.connected = false; elParibuWS.textContent = 'Kapalı'; this._reconnect(); };
    this.ws.onerror = () => { errors++; elErr.textContent = errors; elParibuWS.textContent = 'Hata'; };
    this.ws.onmessage = (ev)=>{
      try{
        const msg = JSON.parse(ev.data);
        if(!msg || !msg.e) return;
        if(msg.e==='orderbook' && msg.s){
          const b = Array.isArray(msg.r?.b) ? msg.r.b : [];
          const a = Array.isArray(msg.r?.a) ? msg.r.a : [];
          this.books.set(msg.s, {b, a, t: msg.E || Date.now()});
          if(msg.s==='usdt_tl'){
            let best = null;
            for(const [p,_] of b){ const fp = parseFloat(p); if(isFinite(fp)) best = (best==null?fp:Math.max(best, fp)); }
            if(best!=null){ usdtryBid = best; if(UI.showUSDT) elUsd.textContent = fmtFixedTR(usdtryBid, 4); }
          }
        } else if(msg.e==='ticker24h' && msg.s==='usdt_tl'){
          const last = parseFloat(msg.r?.c);
          if(isFinite(last)){ usdtryLast = last; if(UI.showUSDT && usdtryBid==null) elUsd.textContent = fmtFixedTR(usdtryLast, 4); }
        }
      }catch(e){}
    };
  }
  _reconnect(){
    if(this.retries>6) return;
    const ms = Math.min(1000*Math.pow(2,this.retries), 8000);
    this.retries++;
    setTimeout(()=>this.connect(), ms);
  }
  _send(obj){
    if(this.ws && this.ws.readyState===WebSocket.OPEN){
      this.ws.send(JSON.stringify(obj));
    }
  }
  bestFromBook(market){ // {bid, ask}
    const data = this.books.get(market);
    if(!data) return {bid:NaN, ask:NaN};
    const bids = data.b || [], asks = data.a || [];
    let bid = null, ask = null;
    for(const [p,_] of bids){ const fp = parseFloat(p); if(isFinite(fp)) bid = (bid==null?fp:Math.max(bid, fp)); }
    for(const [p,_] of asks){ const fp = parseFloat(p); if(isFinite(fp)) ask = (ask==null?fp:Math.min(ask, fp)); }
    return {bid: bid==null?NaN:bid, ask: ask==null?NaN:ask};
  }
  updateWatched(symbols){
    const need = new Set(symbols.map(s => `orderbook:${s.toLowerCase()}_tl@1000ms`));
    // USDT/TRY (orderbook + ticker) her zaman gerekli
    need.add('orderbook:usdt_tl@1000ms');
    need.add('ticker24h:usdt_tl@1000ms');

    const toUnsub = [...this.wantSubs].filter(x => !need.has(x));
    const toSub   = [...need].filter(x => !this.wantSubs.has(x));

    if(this.connected){
      if(toUnsub.length>0) this._send({method:'unsubscribe', channels: toUnsub, id:'pun_'+Date.now()});
      if(toSub.length>0)   this._send({method:'subscribe',   channels: toSub,   id:'psub_'+Date.now()});
    }
    this.wantSubs = need;
  }
}
const PARIBU = new ParibuWS();

/* ====== BINANCE WS (bookTicker) ====== */
class BinanceWS {
  constructor(){
    // 9443 ana endpoint; ihtiyaç olursa 443’e fallback yapılabilir.
    this.url = 'wss://stream.binance.com:9443/ws';
    this.ws = null;
    this.connected = false;
    this.retries = 0;
    this.want = new Set(); // 'btcusdt@bookTicker'...
    this.books = new Map(); // 'BTC' -> {bid, ask, t}
  }
  connect(){
    if(this.ws && (this.ws.readyState===WebSocket.OPEN || this.ws.readyState===WebSocket.CONNECTING)) return;
    try{
      this.ws = new WebSocket(this.url);
    }catch(e){ this._reconnect(); return; }
    elBinWS.textContent = 'Bağlanıyor…';
    this.ws.onopen = () => {
      this.connected = true; this.retries = 0;
      elBinWS.textContent = 'Bağlı';
      if(this.want.size>0) this._send({method:'SUBSCRIBE', params:[...this.want], id: Date.now()});
    };
    this.ws.onclose = () => { this.connected = false; elBinWS.textContent = 'Kapalı'; this._reconnect(); };
    this.ws.onerror = () => { errors++; elErr.textContent = errors; elBinWS.textContent = 'Hata'; };
    this.ws.onmessage = (ev)=>{
      try{
        const msg = JSON.parse(ev.data);
        // bookTicker ham payload (raw /ws) -> e:"bookTicker"
        const data = msg.data || msg; // hem /stream hem /ws uyumu için
        if(data.e==='bookTicker' && data.s){
          const s = data.s; // örn "BTCUSDT"
          if(!s.endsWith('USDT')) return;
          const base = s.slice(0, -4); // "BTC"
          const bid = parseFloat(data.b);
          const ask = parseFloat(data.a);
          if(isFinite(bid) && isFinite(ask)){
            this.books.set(base, {bid, ask, t: data.E || Date.now()});
            if(base==='BTC' && UI.showBTC){
              elBtc.textContent = fmtFixedTR(parseFloat(data.c || ask), 2) || fmtFixedTR(ask,2);
            }
          }
        }
      }catch(e){}
    };
  }
  _reconnect(){
    if(this.retries>6) return;
    const ms = Math.min(1000*Math.pow(2,this.retries), 8000);
    this.retries++;
    setTimeout(()=>this.connect(), ms);
  }
  _send(obj){
    if(this.ws && this.ws.readyState===WebSocket.OPEN){
      this.ws.send(JSON.stringify(obj));
    }
  }
  updateWatched(symbols){
    const need = new Set(symbols.map(s => `${s.toLowerCase()}usdt@bookTicker`));
    const toUnsub = [...this.want].filter(x => !need.has(x));
    const toSub   = [...need].filter(x => !this.want.has(x));

    if(this.connected){
      if(toUnsub.length>0) this._send({method:'UNSUBSCRIBE', params: toUnsub, id: Date.now()});
      if(toSub.length>0)   this._send({method:'SUBSCRIBE',   params: toSub,   id: Date.now()+1});
    }
    this.want = need;
  }
  getBook(base){ // "BTC"
    return this.books.get(base) || {bid:NaN, ask:NaN};
  }
}
const BINANCE = new BinanceWS();

/* ====== Hesap (Paribu TL ↔ Binance USDT) ====== */
function getUsdTry(){
  if(isFinite(usdtryBid)) return usdtryBid;       // en iyi bid
  if(isFinite(usdtryLast)) return usdtryLast;     // yedek
  return NaN;
}

function computeRows(){
  const usdtry = getUsdTry();
  if(!isFinite(usdtry)) return [];

  const syms = Array.from(watched);
  const rows = [];
  for(const sym of syms){
    const paribuMarket = `${sym.toLowerCase()}_tl`;
    const pBest = PARIBU.bestFromBook(paribuMarket);
    const bBook = BINANCE.getBook(sym);

    const bBidTL = bBook.bid * usdtry;
    const bAskTL = bBook.ask * usdtry;

    const diff1 = pBest.bid - bAskTL; // Binance'den AL, Paribu'da SAT
    const diff2 = bBidTL - pBest.ask; // Paribu'dan AL, Binance'de SAT

    let show=false, low=0, high=0, pct=0, lowSrc='', highSrc='', paribuAction=null, paribuPrice=null;
    if((diff1>0 || diff2>0) && isFinite(pBest.bid) && isFinite(pBest.ask) && isFinite(bBidTL) && isFinite(bAskTL)){
      show = true;
      if(diff1 > diff2){
        pct = (diff1 / bAskTL) * 100;
        low = bAskTL; high = pBest.bid; lowSrc='Binance'; highSrc='Paribu';
        paribuAction = 'SAT'; paribuPrice = pBest.bid;
      }else{
        pct = (diff2 / pBest.ask) * 100;
        low = pBest.ask; high = bBidTL; lowSrc='Paribu'; highSrc='Binance';
        paribuAction = 'AL'; paribuPrice = pBest.ask;
      }
    }
    if(show && pct >= (Number(minPctFilter)||0)){
      rows.push({sym, low, high, pct, lowSrc, highSrc, paribuAction, paribuPrice});
    }
  }
  rows.sort((a,b)=> b.pct - a.pct);
  return rows;
}

/* ====== Çizim ====== */
function draw(rows){
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');

    const tdCoin = document.createElement('td');
    tdCoin.className = 'coinCell';
    const sym = document.createElement('span'); sym.className='coinSym'; sym.textContent = r.sym;
    tdCoin.appendChild(sym); tr.appendChild(tdCoin);

    const tdL = document.createElement('td'); tdL.className='mono alCell';
    tdL.textContent = fmt4(r.low);
    tdL.style.background = (r.lowSrc==='Binance') ? 'orange' : 'green';
    tr.appendChild(tdL);

    const tdH = document.createElement('td'); tdH.className='mono satCell';
    tdH.textContent = fmt4(r.high);
    tdH.style.background = (r.highSrc==='Paribu') ? 'green' : 'orange';
    tr.appendChild(tdH);

    const tdP = document.createElement('td'); tdP.className='mono pctCell';
    tdP.textContent = fmtPctTR(r.pct, 2);
    tr.appendChild(tdP);

    frag.appendChild(tr);
  });
  elBody.innerHTML = '';
  elBody.appendChild(frag);
}

/* ====== En Yüksek Fark ====== */
function updateHighlight(rows){
  if(!hiOn || UI.hiPos==='hidden'){ elHiWrap.classList.add('hidden'); return; }
  elHiWrap.classList.remove('hidden');
  placeHi(UI.hiPos);

  if(!rows.length){
    elHiCoin.textContent='—'; elHiAct.textContent='PARİBU • —'; elHiPrice.textContent='—'; elHiPct.textContent='—';
    return;
  }
  const r = rows[0];
  elHiCoin.textContent = r.sym;
  const act = r.paribuAction === 'AL' ? 'AL' : 'SAT';
  elHiAct.textContent = `PARİBU • ${act}`;
  elHiPrice.textContent = `${fmtFixedTR(r.paribuPrice, 2)} TL`;
  elHiPct.textContent = fmtPctTR(r.pct, 2);
}

/* ====== Tema / Kişiselleştirme ====== */
function applyTheme(mode){
  const html = document.documentElement;
  html.classList.remove('theme-dark','theme-light');
  html.classList.add(mode==='light' ? 'theme-light' : 'theme-dark');
  $('#themeSel').value = (mode==='light' ? 'light' : 'dark');
  LS.set('arbi:theme', (mode==='light' ? 'light' : 'dark'));
}
function applyUI(u){
  document.documentElement.style.setProperty('--table-font', u.tableFont+'px');
  document.documentElement.style.setProperty('--cell-pad-y', u.padY+'px');
  document.documentElement.style.setProperty('--cell-pad-x', u.padX+'px');
  document.documentElement.style.setProperty('--row-gap', u.rowGap+'px');
  document.documentElement.style.setProperty('--cell-radius', u.radius+'px');
  document.documentElement.style.setProperty('--container-max', u.maxW+'px');
  document.documentElement.style.setProperty('--col-coin', (u.col.coin||28)+'%');
  document.documentElement.style.setProperty('--col-al',   (u.col.al||27)+'%');
  document.documentElement.style.setProperty('--col-sat',  (u.col.sat||27)+'%');
  document.documentElement.style.setProperty('--col-pct',  (u.col.pct||18)+'%');
  document.documentElement.style.setProperty('--card-font', u.cardFont+'px');

  elBtcBox.style.display = u.showBTC ? '' : 'none';
  elUsdBox.style.display = u.showUSDT ? '' : 'none';

  placeHi(u.hiPos);

  $('#ui_tableFont_val').textContent = u.tableFont+'px';
  $('#ui_padY_val').textContent = u.padY+'px';
  $('#ui_padX_val').textContent = u.padX+'px';
  $('#ui_rowGap_val').textContent = u.rowGap+'px';
  $('#ui_radius_val').textContent = u.radius+'px';
  $('#ui_maxW_val').textContent = u.maxW+'px';
  $('#ui_cardFont_val').textContent = u.cardFont+'px';

  $('#ui_tableFont').value = u.tableFont; $('#ui_padY').value = u.padY; $('#ui_padX').value = u.padX;
  $('#ui_rowGap').value = u.rowGap; $('#ui_radius').value = u.radius; $('#ui_maxW').value = u.maxW;
  $('#ui_cardFont').value = u.cardFont; $('#ui_colCoin').value = u.col.coin; $('#ui_colAl').value = u.col.al;
  $('#ui_colSat').value = u.col.sat; $('#ui_colPct').value = u.col.pct; $('#ui_hiPos').value = u.hiPos;
  $('#ui_showBTC').checked = !!u.showBTC; $('#ui_showUSDT').checked = !!u.showUSDT;

  const sum = (+u.col.coin)+(+u.col.al)+(+u.col.sat)+(+u.col.pct);
  const ok = Math.round(sum)===100;
  $('#ui_colSum').textContent = 'Toplam: '+sum.toFixed(0)+'% ' + (ok?'✓':'(100 olmalı — otomatik normalize edilir)');
}
function saveUI(){ LS.set('arbi:UI', UI); }
function normalizeCols(){
  let {coin,al,sat,pct} = UI.col;
  let sum = coin+al+sat+pct;
  if(sum<=0) { UI.col={coin:28,al:27,sat:27,pct:18}; return; }
  UI.col.coin = +(coin*100/sum).toFixed(0);
  UI.col.al   = +(al*100/sum).toFixed(0);
  UI.col.sat  = +(sat*100/sum).toFixed(0);
  UI.col.pct  = 100 - UI.col.coin - UI.col.al - UI.col.sat;
}
function placeHi(pos){
  const wrap = elHiWrap;
  if(pos==='hidden'){ wrap.classList.add('hidden'); return; }
  wrap.classList.remove('hidden');
  if(pos==='top')        $('#anchorTop').after(wrap);
  else if(pos==='afterControls') $('#anchorAfterControls').after(wrap);
  else if(pos==='afterTable') $('#anchorAfterTable').after(wrap);
}

/* ====== UI / Kontroller (kalıcı) ====== */
function renderChips(){
  const wrap = $('#chips'); wrap.innerHTML='';
  Array.from(watched).sort().forEach(sym=>{
    const d = document.createElement('div'); d.className='chip';
    d.innerHTML = `<span>${sym}</span>`;
    const b = document.createElement('button'); b.textContent='×';
    b.onclick = ()=>{
      watched.delete(sym);
      LS.set('arbi:watched', Array.from(watched));
      $('#cnt').textContent = watched.size; renderChips();
      PARIBU.updateWatched(Array.from(watched));
      BINANCE.updateWatched(Array.from(watched));
    };
    d.appendChild(b); wrap.appendChild(d);
  });
  $('#cnt').textContent = watched.size;
}
function schedule(ms){
  refreshMs = Math.max(100, Math.min(4000, ms|0));
  elRng.value = refreshMs;
  elRngLbl.textContent = (refreshMs/1000).toFixed(1)+' sn';
  LS.set('arbi:interval', refreshMs);
  if(timer) clearInterval(timer);
  timer = setInterval(mainTick, refreshMs);
}

/* ====== Main Tick ====== */
function mainTick(){
  try{
    // USDT-TRY görsel
    const usdtry = getUsdTry();
    if(UI.showUSDT && isFinite(usdtry)) elUsd.textContent = fmtFixedTR(usdtry, 4);

    // tablo
    const rows = computeRows();
    draw(rows);
    updateHighlight(rows);

    elLast.textContent = nowStr();
  }catch(e){
    errors++; elErr.textContent = errors;
  }
}

/* ====== Eventler ====== */
$('#add').onclick = ()=>{
  const raw = $('#coinIn').value;
  const sym = norm(raw);
  if(sym){
    watched.add(sym);
    LS.set('arbi:watched', Array.from(watched));
    renderChips();
    PARIBU.updateWatched(Array.from(watched));
    BINANCE.updateWatched(Array.from(watched));
  }
  $('#coinIn').value='';
};
$('#coinIn').addEventListener('keydown',(e)=>{ if(e.key==='Enter') $('#add').click(); });

$('#clear').onclick = ()=>{
  watched.clear();
  LS.set('arbi:watched', []);
  renderChips(); elBody.innerHTML='';
  PARIBU.updateWatched([]);
  BINANCE.updateWatched([]);
};

elRng.addEventListener('input', e=> schedule(Number(e.target.value)));
elMin.addEventListener('input', e=>{
  minPctFilter = Number(e.target.value)||0;
  LS.set('arbi:minpct', minPctFilter);
});
elThemeSel.addEventListener('change', (e)=> applyTheme(e.target.value));

elHiToggle.addEventListener('click', ()=>{
  hiOn = !hiOn;
  LS.set('arbi:hiOn', hiOn);
  elHiToggle.textContent = 'En Yüksek Fark: ' + (hiOn ? 'Açık' : 'Kapalı');
  updateHighlight([]);
});
elCustomToggle.addEventListener('click', ()=>{
  const open = elCustomWrap.classList.toggle('hidden');
  elCustomToggle.textContent = 'Kişiselleştir: ' + (open ? 'Kapalı' : 'Açık');
});

/* Kişiselleştirme inputları */
$('#ui_tableFont').oninput = (e)=>{ UI.tableFont=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_padY').oninput = (e)=>{ UI.padY=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_padX').oninput = (e)=>{ UI.padX=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_rowGap').oninput = (e)=>{ UI.rowGap=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_radius').oninput = (e)=>{ UI.radius=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_maxW').oninput = (e)=>{ UI.maxW=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_cardFont').oninput = (e)=>{ UI.cardFont=+e.target.value; applyUI(UI); saveUI(); };
$('#ui_hiPos').onchange = (e)=>{ UI.hiPos=e.target.value; applyUI(UI); saveUI(); };
$('#ui_showBTC').onchange = (e)=>{ UI.showBTC=e.target.checked; elBtcBox.style.display = e.target.checked?'':'none'; saveUI(); };
$('#ui_showUSDT').onchange = (e)=>{ UI.showUSDT=e.target.checked; elUsdBox.style.display = e.target.checked?'':'none'; saveUI(); };
['ui_colCoin','ui_colAl','ui_colSat','ui_colPct'].forEach(id=>{
  $('#'+id).addEventListener('input',(e)=>{
    const v = Math.max(10, Math.min(60, +e.target.value||0));
    if(id==='ui_colCoin') UI.col.coin=v;
    if(id==='ui_colAl')   UI.col.al=v;
    if(id==='ui_colSat')  UI.col.sat=v;
    if(id==='ui_colPct')  UI.col.pct=v;
    normalizeCols();
    applyUI(UI); saveUI();
  });
});
$('#ui_reset').onclick = ()=>{ UI = JSON.parse(JSON.stringify(UI_DEFAULTS)); applyUI(UI); saveUI(); };

/* ====== Başlat ====== */
(function init(){
  if(watched.size===0){
    ['BTC','ETH','SOL','AVAX','XRP'].forEach(s=>watched.add(s));
    LS.set('arbi:watched', Array.from(watched));
  }
  applyTheme(themeMode);
  renderChips();
  applyUI(UI);
  $('#minPct').value = isFinite(minPctFilter)? minPctFilter : 0.00;
  elHiToggle.textContent = 'En Yüksek Fark: ' + (hiOn ? 'Açık' : 'Kapalı');

  // WS bağlantıları
  PARIBU.connect();
  BINANCE.connect();
  PARIBU.updateWatched(Array.from(watched));
  BINANCE.updateWatched(Array.from(watched));

  // Tick döngüsü
  schedule(isFinite(refreshMs) ? refreshMs : 1000);
  elLast.textContent = nowStr();

  // Arka planda sadece zamanı tazele
  setInterval(()=>{ if(watched.size===0) elLast.textContent = nowStr(); }, 1000);
})();
</script>
</body>
</html>
