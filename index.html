<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>MEXC Spot ⇄ Futures Arb (USDT) — Yeşil: Spot, Turuncu: Futures</title>
<style>
  :root{
    --bg:#0b1220; --fg:#e6edf7; --muted:#9fb0c9; --panel:#0f1629; --panel2:#111a2e; --border:#1a2a4a;
    --spot:#16a34a;      /* YEŞİL: SPOT */
    --fut:#f59e0b;       /* TURUNCU: FUTURES */
    --danger:#ef4444; --ok:#22c55e;
    --fontRow:18px; --padY:12px; --padX:10px; --gap:8px; --radius:12px; --maxW:1200px;
  }
  body.light{
    --bg:#ffffff; --fg:#0b1220; --muted:#556176; --panel:#f3f6fb; --panel2:#ffffff; --border:#d8e1ef;
    --spot:#16a34a; --fut:#d97706;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{padding:14px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),transparent)}
  .wrap{max-width:var(--maxW);margin:0 auto}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{margin:0;font-size:20px}
  .legend{display:flex;gap:10px;align-items:center}
  .dot{width:10px;height:10px;border-radius:50%}
  .spot{background:var(--spot)} .fut{background:var(--fut)}
  .chip{background:var(--panel2);border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:12px;color:var(--muted);display:inline-flex;gap:8px;align-items:center}
  .btn{border:1px solid var(--border);background:var(--panel2);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn:hover{border-color:var(--spot)}
  input,select{background:var(--panel2);border:1px solid var(--border);color:var(--fg);border-radius:10px;padding:8px 10px}
  label{font-size:12px;color:var(--muted)}
  .controls{display:grid;grid-template-columns:repeat(6,minmax(180px,1fr));gap:10px;margin-top:10px}
  .card{background:var(--panel2);border:1px solid var(--border);border-radius:14px;padding:10px}
  #topCard{margin:12px 0;padding:12px 14px;border-radius:16px;background:var(--panel2);border:1px solid var(--border);display:flex;gap:12px;align-items:baseline;flex-wrap:wrap}
  #topCard.hidden{display:none}
  #topBadge{font-weight:800;color:#091220;border-radius:999px;padding:6px 10px}
  .bSpot{background:var(--spot)} .bFut{background:var(--fut)}
  .mono{font-variant-numeric:tabular-nums;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  table{width:100%;border-collapse:separate;border-spacing:0 var(--gap)}
  thead th{font-size:14px;color:var(--muted);text-align:left;padding:0 8px}
  tbody td{padding:var(--padY) var(--padX);font-size:var(--fontRow);background:var(--panel2);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
  tbody tr td:first-child{border-top-left-radius:var(--radius);border-bottom-left-radius:var(--radius)}
  tbody tr td:last-child{border-top-right-radius:var(--radius);border-bottom-right-radius:var(--radius)}
  .alCell,.satCell,.pctCell{text-align:center;font-weight:800}
  .src-spot{background:var(--spot) !important;color:#091220}
  .src-fut{background:var(--fut) !important;color:#111}
  .pctPos{color:var(--ok);font-weight:800} .pctNeg{color:var(--danger);font-weight:800}
  .blink{animation:blink 1s ease-in-out 1} @keyframes blink{50%{opacity:.55}}
  .note{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <h1>MEXC Spot ⇄ Futures Fark (USDT)</h1>
      <div class="legend chip"><span class="dot spot"></span>SPOT <span class="dot fut"></span>FUTURES</div>
      <div class="chip">BTC (Futures): <b id="btc" class="mono">—</b></div>
      <div class="chip">Son: <span id="clock" class="mono">—:—:—</span></div>
      <div style="margin-left:auto" class="row">
        <label>Tema</label>
        <select id="themeSel"><option value="dark">Koyu</option><option value="light">Beyaz</option></select>
      </div>
    </div>

    <div id="topCard" class="card">
      <span id="topSym" style="font-weight:800;font-size:22px">—</span>
      <span id="topBadge" class="bSpot">SPOT • —</span>
      <span id="topPrice" class="mono" style="font-weight:700">—</span>
      <span id="topPct" class="mono" style="font-weight:800">—</span>
      <span class="note">En yüksek fark — AL/SAT kaynağına göre rozet rengi değişir.</span>
    </div>

    <div class="controls">
      <div class="card">
        <label for="addSym">Coin ekle (örn: <b>ETH</b> ya da <b>ETH_USDT</b>)</label>
        <div class="row" style="margin-top:6px">
          <input id="addSym" type="text" placeholder="Sembol"/>
          <button id="btnAdd" class="btn">Ekle</button>
          <button id="btnClear" class="btn">Tümünü Sil</button>
        </div>
        <div class="note" style="margin-top:6px">Sadece eklediklerin izlenir; liste kayıtlı kalır.</div>
      </div>
      <div class="card">
        <label for="speed">Görsel yenileme</label>
        <select id="speed">
          <option value="100">0.1 sn</option>
          <option value="200">0.2 sn</option>
          <option value="300">0.3 sn</option>
          <option value="500">0.5 sn</option>
          <option value="1000" selected>1 sn</option>
          <option value="2000">2 sn</option>
          <option value="4000">4 sn</option>
        </select>
        <div class="note" style="margin-top:6px">WS sürekli akar; bu sadece DOM güncelleme hızıdır.</div>
      </div>
      <div class="card">
        <label for="thresh">Fark eşiği (%)</label>
        <input id="thresh" type="number" step="0.01" value="0.10"/>
        <div class="note" style="margin-top:6px">Bu yüzdeyi aşan farklar listelenir.</div>
      </div>
      <div class="card">
        <label>Listeyi dışa/içe aktar</label>
        <div class="row" style="margin-top:6px">
          <button id="btnExport" class="btn">Dışa aktar</button>
          <button id="btnImport" class="btn">İçe al</button>
          <input id="fileImport" type="file" accept="application/json" style="display:none"/>
        </div>
      </div>
      <div class="card">
        <label>En yüksek fark kartı</label>
        <div style="margin-top:6px" class="row">
          <label class="row"><input type="checkbox" id="toggleTop" checked/> Göster</label>
        </div>
      </div>
      <div class="card">
        <label>Bilgi</label>
        <div class="note" style="margin-top:6px">AL = ucuz taraf, SAT = pahalı taraf. Yeşil **SPOT**, turuncu **FUTURES**.</div>
      </div>
    </div>
  </div>
</header>

<main class="wrap" style="padding:12px 0">
  <table>
    <thead>
      <tr><th>Coin</th><th>AL</th><th>SAT</th><th>% Fark</th></tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <p class="note" style="margin:10px 2px">Not: Net kârlılık komisyon, slipaj, teminat vb. faktörlere bağlıdır.</p>
</main>

<script>
/* ===== Yardımcılar & durum ===== */
const $ = s=>document.querySelector(s);
const fmt=(n,d=4)=>isFinite(n)?(+n).toFixed(d):'—';
const pct=(p)=>isFinite(p)?(p>=0?'+':'')+p.toFixed(3)+'%':'—';
const now=()=>new Date().toLocaleTimeString('tr-TR',{hour12:false});

const S = {
  coins: new Set(),
  spot: new Map(),   // key: "BTCUSDT"  val: {bid,ask,ts}
  fut:  new Map(),   // key: "BTC_USDT" val: {bid,ask,ts}
  ui: {
    speed:+(localStorage.getItem('mxf:speed')||1000),
    thresh:+(localStorage.getItem('mxf:thresh')||0.10),
    theme: localStorage.getItem('mxf:theme') || 'dark',
    showTop: JSON.parse(localStorage.getItem('mxf:showTop')||'true')
  },
  timers:{ render:null, clock:null },
  conns:{ spot:[], fut:null },
  spotMax:28
};

function save(){
  localStorage.setItem('mxf:list', JSON.stringify([...S.coins]));
  localStorage.setItem('mxf:speed', S.ui.speed);
  localStorage.setItem('mxf:thresh', S.ui.thresh);
  localStorage.setItem('mxf:theme', S.ui.theme);
  localStorage.setItem('mxf:showTop', S.ui.showTop);
}
function load(){
  try{
    const arr=JSON.parse(localStorage.getItem('mxf:list')||'[]'); arr.forEach(x=>S.coins.add(x));
  }catch{}
}

/* ===== Protobuf mini decoder (yalnızca gereken alanlar) ===== */
function readVar(u8,i){let x=0n,s=0n,p=i;for(;;){const b=u8[p++];x|=BigInt(b&0x7f)<<s;if(!(b&0x80))break;s+=7n;}return [Number(x),p];}
function readStr(u8,i){let len;[len,i]=readVar(u8,i);const b=u8.slice(i,i+len);i+=len;return [new TextDecoder().decode(b),i];}
function skip(u8,i,wt){if(wt===0){let _;[_,i]=readVar(u8,i);return i;} if(wt===1)return i+8; if(wt===2){let l;[l,i]=readVar(u8,i);return i+l;} if(wt===5)return i+4; return i;}
function decBook(u8){let i=0,o={};while(i<u8.length){let k;[k,i]=readVar(u8,i);const f=k>>3,w=k&7;if(w===2){if(f===1){let s;[s,i]=readStr(u8,i);o.bidPrice=s;}else if(f===2){let s;[s,i]=readStr(u8,i);o.bidQuantity=s;}else if(f===3){let s;[s,i]=readStr(u8,i);o.askPrice=s;}else if(f===4){let s;[s,i]=readStr(u8,i);o.askQuantity=s;}else{let l;[l,i]=readVar(u8,i);i+=l;}}else{i=skip(u8,i,w);} }return o;}
function decWrap(buf){const u8=new Uint8Array(buf);let i=0,o={};while(i<u8.length){let k;[k,i]=readVar(u8,i);const f=k>>3,w=k&7;if(f===1&&w===2){let s;[s,i]=readStr(u8,i);o.channel=s;} else if((f===305||f===315)&&w===2){let l;[l,i]=readVar(u8,i);const b=u8.slice(i,i+l);i+=l;o.book=decBook(b);} else if(f===3&&w===2){let s;[s,i]=readStr(u8,i);o.symbol=s;} else if(w===2){let l;[l,i]=readVar(u8,i);i+=l;} else if(w===0){let _;[_,i]=readVar(u8,i);} else if(w===1){i+=8;} else if(w===5){i+=4;} }return o;}
function chSym(ch){const p=String(ch).split('@');return p[p.length-1]||null;}

/* ===== WS: Spot (protobuf) ===== */
class SpotWS{
  constructor(){this.ws=null;this.list=new Set();this.timer=null;}
  connect(){
    this.ws=new WebSocket('wss://wbs-api.mexc.com/ws'); this.ws.binaryType='arraybuffer';
    this.ws.onopen=()=>{ this.ping(); if(this.list.size) this.subBulk([...this.list]); };
    this.ws.onmessage=(ev)=>{
      if(typeof ev.data==='string') return; // ack/pong vb.
      const m=decWrap(ev.data);
      if(m?.book){
        const s=(m.symbol||chSym(m.channel)); if(!s) return;
        const bid=parseFloat(m.book.bidPrice), ask=parseFloat(m.book.askPrice);
        if(isFinite(bid)&&isFinite(ask)) S.spot.set(s,{bid,ask,ts:Date.now()});
      }
    };
    this.ws.onclose=()=>setTimeout(()=>this.connect(),1000);
    this.ws.onerror =()=>{ try{this.ws.close()}catch{} };
  }
  ping(){ clearInterval(this.timer); this.timer=setInterval(()=>{ try{this.ws?.readyState===1&&this.ws.send(JSON.stringify({method:"PING"}));}catch{} },20000); }
  sub(sym){ this.list.add(sym); if(this.ws?.readyState===1) this.ws.send(JSON.stringify({method:"SUBSCRIPTION", params:[`spot@public.aggre.bookTicker.v3.api.pb@100ms@${sym.replace('_','')}`]})); }
  unsub(sym){ this.list.delete(sym); if(this.ws?.readyState===1) this.ws.send(JSON.stringify({method:"UNSUBSCRIPTION", params:[`spot@public.aggre.bookTicker.v3.api.pb@100ms@${sym.replace('_','')}`]})); }
  subBulk(arr){ arr.forEach(s=>this.sub(s)); }
}

/* ===== WS: Futures (JSON) ===== */
class FutWS{
  constructor(){this.ws=null;this.list=new Set();this.timer=null;}
  connect(){
    this.ws=new WebSocket('wss://contract.mexc.com/edge');
    this.ws.onopen=()=>{ this.ping(); if(this.list.size) this.subBulk([...this.list]); this.sub('BTC_USDT'); };
    this.ws.onmessage=(ev)=>{
      try{
        const j=JSON.parse(ev.data);
        if(j.channel==='push.ticker' && j.data && j.symbol){
          const s=j.symbol; const bid=+j.data.bid1, ask=+j.data.ask1;
          if(isFinite(bid)&&isFinite(ask)) S.fut.set(s,{bid,ask,ts:Date.now()});
          if(s==='BTC_USDT'){ $('#btc').textContent=(+j.data.lastPrice).toFixed(2)+' USDT'; }
        }
      }catch{}
    };
    this.ws.onclose =()=>setTimeout(()=>this.connect(),1000);
    this.ws.onerror=()=>{ try{this.ws.close()}catch{} };
  }
  ping(){ clearInterval(this.timer); this.timer=setInterval(()=>{ try{this.ws?.readyState===1&&this.ws.send(JSON.stringify({method:"ping"}));}catch{} },20000); }
  sub(sym){ this.list.add(sym); if(this.ws?.readyState===1) this.ws.send(JSON.stringify({method:"sub.ticker", param:{symbol:sym}})); }
  unsub(sym){ this.list.delete(sym); if(this.ws?.readyState===1) this.ws.send(JSON.stringify({method:"unsub.ticker", param:{symbol:sym}})); }
  subBulk(arr){ arr.forEach(s=>this.sub(s)); }
}

/* ===== WS havuzu (spot için 28/bağlantı) ===== */
function spotConnFor(idx){
  const pool=S.conns.spot; const need=Math.floor(idx/S.spotMax);
  while(pool.length<=need){ const ws=new SpotWS(); ws.connect(); pool.push(ws); }
  return pool[need];
}

/* ===== Liste/normalize ===== */
function norm(x){ x=(x||'').trim().toUpperCase(); if(!x.includes('_')) x=x+'_USDT'; return x.replace(/[^A-Z0-9_]/g,''); }
function addSym(v){
  const sym=norm(v); if(!sym||S.coins.has(sym)) return;
  const idx=S.coins.size; S.coins.add(sym);
  spotConnFor(idx).sub(sym); if(!S.conns.fut){ S.conns.fut=new FutWS(); S.conns.fut.connect(); }
  S.conns.fut.sub(sym); save(); blinkTop();
}
function delAll(){
  S.conns.spot.forEach(ws=>{ [...S.coins].forEach(s=>ws.unsub(s)); });
  if(S.conns.fut) [...S.coins].forEach(s=>S.conns.fut.unsub(s));
  S.coins.clear(); save();
}

/* ===== Hesap & Çizim ===== */
function computeRows(){
  const rows=[];
  for(const sym of S.coins){
    // Spot key bazen BTCUSDT, bazen BTC_USDT -> ikisini de kontrol et
    const sp = S.spot.get(sym.replace('_','')) || S.spot.get(sym) || null;
    const fu = S.fut.get(sym) || null;
    if(!sp||!fu) continue;

    // İki yön: (1) spot AL + fut SAT  (2) fut AL + spot SAT
    const diff1 = fu.bid - sp.ask;          // ucuz: spot (AL), pahalı: fut (SAT)
    const pct1  = diff1 / sp.ask * 100;
    const diff2 = sp.bid - fu.ask;          // ucuz: fut (AL), pahalı: spot (SAT)
    const pct2  = diff2 / fu.ask * 100;

    if(pct1<=0 && pct2<=0) continue;

    let low,high,pct,lowSrc,highSrc,act,actPrice;
    if(pct1 >= pct2){
      low=sp.ask; high=fu.bid; pct=pct1; lowSrc='spot'; highSrc='fut'; act='AL'; actPrice=sp.ask;
    }else{
      low=fu.ask; high=sp.bid; pct=pct2; lowSrc='fut'; highSrc='spot'; act='AL'; actPrice=lowSrc==='spot'?sp.ask:fu.ask;
      // Üst kartta gösterilecek eylem metni, AL/SAT mantığına göre:
      // burada zaten "AL" ucuz tarafta; kartta "SPOT • AL" ya da "FUTURES • AL" yazacağız.
    }
    // Eğer ucuz tarafta AL varsa, pahalı tarafta doğal olarak SAT olur; tabloya SAT için high yazıyoruz
    rows.push({sym, low, high, pct, lowSrc, highSrc, act, actPrice});
  }
  rows.sort((a,b)=>b.pct-a.pct);
  // filtre uygula
  const thr = Number(S.ui.thresh)||0;
  return rows.filter(r=> r.pct >= thr);
}

function render(){
  const rows = computeRows();
  // Üst kart
  const top = $('#topCard');
  if(!S.ui.showTop || rows.length===0){ top.classList.add('hidden'); }
  else{
    top.classList.remove('hidden');
    const r=rows[0];
    $('#topSym').textContent = r.sym.split('_')[0];
    const isSpot = (r.lowSrc==='spot');
    const badge = $('#topBadge');
    badge.className = isSpot ? 'bSpot' : 'bFut';
    badge.textContent = (isSpot ? 'SPOT' : 'FUTURES') + ' • AL';
    $('#topPrice').textContent = fmt(r.low,4)+' USDT';
    $('#topPct').textContent = pct(r.pct);
    top.classList.add('blink'); setTimeout(()=>top.classList.remove('blink'), 300);
  }

  // Tablo
  const tb = $('#tbody'); tb.innerHTML='';
  for(const r of rows){
    const tr = document.createElement('tr');

    const tdC = document.createElement('td'); tdC.textContent = r.sym; tdC.style.fontWeight='800';
    const tdL = document.createElement('td'); tdL.className='alCell mono ' + (r.lowSrc==='spot'?'src-spot':'src-fut'); tdL.textContent = fmt(r.low,4);
    const tdH = document.createElement('td'); tdH.className='satCell mono ' + (r.highSrc==='spot'?'src-spot':'src-fut'); tdH.textContent = fmt(r.high,4);
    const tdP = document.createElement('td'); tdP.className='pctCell mono'; tdP.innerHTML = `<span class="${r.pct>=0?'pctPos':'pctNeg'}">${pct(r.pct)}</span>`;

    tr.append(tdC,tdL,tdH,tdP);
    tb.appendChild(tr);
  }
  $('#clock').textContent = now();
}

/* ===== Tema & UI ===== */
function applyTheme(){ document.body.classList.toggle('light', S.ui.theme==='light'); $('#themeSel').value=S.ui.theme; }
function tickRender(){ clearInterval(S.timers.render); S.timers.render=setInterval(render, Math.max(100,Math.min(4000,S.ui.speed|0))); }

/* ===== Eventler ===== */
$('#btnAdd').onclick = ()=>{ const v=$('#addSym').value.trim(); if(!v) return; addSym(v); $('#addSym').value=''; render(); };
$('#addSym').addEventListener('keydown',e=>{ if(e.key==='Enter') $('#btnAdd').click(); });
$('#btnClear').onclick = ()=>{ if(confirm('Tüm coinleri sil?')){ delAll(); render(); } };
$('#speed').onchange = e=>{ S.ui.speed=+e.target.value; save(); tickRender(); };
$('#thresh').onchange = e=>{ S.ui.thresh=+e.target.value; save(); render(); };
$('#themeSel').onchange = e=>{ S.ui.theme=e.target.value; save(); applyTheme(); };
$('#btnExport').onclick = ()=>{
  const data = JSON.stringify({coins:[...S.coins]}, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='mexc-list.json'; a.click(); URL.revokeObjectURL(a.href);
};
$('#btnImport').onclick = ()=> $('#fileImport').click();
$('#fileImport').onchange = async e=>{
  const f=e.target.files?.[0]; if(!f) return;
  try{ const txt=await f.text(); const obj=JSON.parse(txt); if(Array.isArray(obj.coins)) obj.coins.forEach(s=>addSym(s)); render(); }catch{ alert('Geçersiz dosya'); }
};
$('#toggleTop').onchange = e=>{ S.ui.showTop = e.target.checked; save(); render(); };

/* ===== Başlat ===== */
(function init(){
  load();
  // kontrolleri doldur
  $('#speed').value = String(S.ui.speed);
  $('#thresh').value = String(S.ui.thresh);
  $('#themeSel').value = S.ui.theme;
  $('#toggleTop').checked = !!S.ui.showTop;
  applyTheme();

  // WS bağlantıları
  // spot havuzu ilk bağlantı
  const first = new SpotWS(); first.connect(); S.conns.spot.push(first);
  // futures bağlantısı
  S.conns.fut = new FutWS(); S.conns.fut.connect();

  // kayıtlı coinleri abone et
  [...S.coins].forEach((sym,i)=>{ spotConnFor(i).sub(sym); S.conns.fut.sub(sym); });

  // saat
  S.timers.clock=setInterval(()=>$('#clock').textContent=now(), 1000);

  tickRender();
  render();
})();
function blinkTop(){ const el=$('#topCard'); el.classList.add('blink'); setTimeout(()=>el.classList.remove('blink'),300); }
</script>
</body>
</html>
